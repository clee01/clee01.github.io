<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"clee01.github.io","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.23.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js" defer></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="Hello, my world!">
<meta property="og:url" content="https://clee01.github.io/index.html">
<meta property="og:site_name" content="Hello, my world!">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Claark Lee">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://clee01.github.io/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Hello, my world!</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  

  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/11.5.0/mermaid.min.js","integrity":"sha256-2obLuIPcceEhkE3G09G33hBdmE55ivVcZUlcKcGNHjU="}}</script>
  <script src="/js/third-party/tags/mermaid.js" defer></script>





  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Hello, my world!</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>







</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Claark Lee</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">13</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://clee01.github.io/2025/04/27/SFINAE%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Claark Lee">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hello, my world!">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Hello, my world!">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/04/27/SFINAE%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">SFINAEç¬”è®°</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-04-27 22:02:51 / Modified: 23:14:18" itemprop="dateCreated datePublished" datetime="2025-04-27T22:02:51+08:00">2025-04-27</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="å†™åœ¨å‰é¢"><a href="#å†™åœ¨å‰é¢" class="headerlink" title="å†™åœ¨å‰é¢"></a>å†™åœ¨å‰é¢</h2><p>SFINAE: Substitution Failure Is Not An Error</p>
<h2 id="ğŸ“˜-SFINAEä¸ºä»£ç å¸¦æ¥çš„ä»·å€¼"><a href="#ğŸ“˜-SFINAEä¸ºä»£ç å¸¦æ¥çš„ä»·å€¼" class="headerlink" title="ğŸ“˜ SFINAEä¸ºä»£ç å¸¦æ¥çš„ä»·å€¼"></a>ğŸ“˜ SFINAEä¸ºä»£ç å¸¦æ¥çš„ä»·å€¼</h2><h3 id="SFINAEçš„ä½œç”¨"><a href="#SFINAEçš„ä½œç”¨" class="headerlink" title="SFINAEçš„ä½œç”¨"></a>SFINAEçš„ä½œç”¨</h3><p>SFINAEå…è®¸åœ¨æ¨¡æ¿å®ä¾‹åŒ–è¿‡ç¨‹ä¸­æ ¹æ®ç±»å‹ç‰¹æ€§é€‰æ‹©æ€§åœ°å¯ç”¨æˆ–ç¦ç”¨å‡½æ•°æˆ–ç±»æ¨¡æ¿ï¼Œä»è€Œå®ç°æ›´çµæ´»çš„ä»£ç è®¾è®¡</p>
<h3 id="ğŸ§ª-ç¤ºä¾‹åˆ†æ"><a href="#ğŸ§ª-ç¤ºä¾‹åˆ†æ" class="headerlink" title="ğŸ§ª ç¤ºä¾‹åˆ†æ"></a>ğŸ§ª ç¤ºä¾‹åˆ†æ</h3><p>è€ƒè™‘ä»¥ä¸‹ç±»æ¨¡æ¿ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyClass</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">f</span><span class="params">(T <span class="type">const</span>&amp; x)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">f</span><span class="params">(T&amp;&amp; x)</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>å½“Tæ˜¯å¼•ç”¨ç±»å‹ï¼ˆä¾‹å¦‚int&amp;ï¼‰æ—¶ï¼Œä¸¤ä¸ªé‡è½½å‡½æ•°çš„ç­¾åå¯èƒ½ä¼šå‘ç”Ÿå†²çªï¼Œå¯¼è‡´ç¼–è¯‘é”™è¯¯</p>
<h3 id="ğŸ› ï¸-è§£å†³æ–¹æ¡ˆ"><a href="#ğŸ› ï¸-è§£å†³æ–¹æ¡ˆ" class="headerlink" title="ğŸ› ï¸ è§£å†³æ–¹æ¡ˆ"></a>ğŸ› ï¸ è§£å†³æ–¹æ¡ˆ</h3><p>é€šè¿‡å¼•å…¥std::enable_ifï¼Œå¯ä»¥æ ¹æ®ç±»å‹ç‰¹æ€§æœ‰æ¡ä»¶åœ°å¯ç”¨å‡½æ•°æ¨¡æ¿ï¼Œä»è€Œé¿å…é‡è½½å†²çªã€‚ä¾‹å¦‚ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyClass</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">f</span><span class="params">(T <span class="type">const</span>&amp; x)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T_ </span>= T&gt;</span><br><span class="line">  <span class="built_in">f</span>(T&amp;&amp; x, <span class="keyword">typename</span> std::enable_if&lt;!std::is_reference&lt;T_&gt;::value,</span><br><span class="line">           std::<span class="type">nullptr_t</span>&gt;::type = <span class="literal">nullptr</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>è¿™æ ·ï¼Œå½“Tæ˜¯å¼•ç”¨ç±»å‹æ—¶ï¼Œç¬¬äºŒä¸ªé‡è½½å‡½æ•°å°†è¢«ç¦ç”¨ï¼Œé¿å…äº†é‡è½½å†²çª</p>
<h2 id="ğŸ“™-SFINAEçš„éšè—ä¹‹ç¾"><a href="#ğŸ“™-SFINAEçš„éšè—ä¹‹ç¾" class="headerlink" title="ğŸ“™ SFINAEçš„éšè—ä¹‹ç¾"></a>ğŸ“™ SFINAEçš„éšè—ä¹‹ç¾</h2><h3 id="ğŸ¯-é—®é¢˜ï¼šSFINAEè¯­æ³•çš„å†—é•¿"><a href="#ğŸ¯-é—®é¢˜ï¼šSFINAEè¯­æ³•çš„å†—é•¿" class="headerlink" title="ğŸ¯ é—®é¢˜ï¼šSFINAEè¯­æ³•çš„å†—é•¿"></a>ğŸ¯ é—®é¢˜ï¼šSFINAEè¯­æ³•çš„å†—é•¿</h3><p>ä¼ ç»Ÿçš„SFINAEå†™æ³•è¾ƒä¸ºå†—é•¿ï¼Œå½±å“ä»£ç å¯è¯»æ€§ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typename</span> std::enable_if&lt;!std::is_reference&lt;T&gt;::value, std::<span class="type">nullptr_t</span>&gt;::type = <span class="literal">nullptr</span>;</span><br></pre></td></tr></table></figure>

<h3 id="âœ¨-ä¼˜åŒ–æ–¹æ³•"><a href="#âœ¨-ä¼˜åŒ–æ–¹æ³•" class="headerlink" title="âœ¨ ä¼˜åŒ–æ–¹æ³•"></a>âœ¨ ä¼˜åŒ–æ–¹æ³•</h3><p>åˆ©ç”¨</p>
<ul>
<li>C++14å¼•å…¥çš„åˆ«åæ¨¡æ¿</li>
<li>C++17å¼•å…¥çš„è¾…åŠ©å˜é‡æ¨¡æ¿</li>
<li>ç°ä»£C++æ¨èæŠŠSFINAEæ¡ä»¶å†™åˆ°æ¨¡æ¿å‚æ•°é‡Œ</li>
</ul>
<p>å¯ä»¥ç®€åŒ–SFINAEçš„å†™æ³•ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">std::<span class="type">enable_if_t</span>&lt;!std::is_reference_v&lt;T&gt;, std::<span class="type">nullptr_t</span>&gt; = <span class="literal">nullptr</span>;</span><br></pre></td></tr></table></figure>
<p>æ­¤å¤–ï¼Œåœ¨C++11ä¸­ï¼Œå¯ä»¥ä½¿ç”¨{}æ¥å®ä¾‹åŒ–ç±»å‹ç‰¹å¾ç±»ï¼Œä»è€Œé¿å…æ˜¾å¼ä½¿ç”¨.valueï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">std::<span class="type">enable_if_t</span>&lt;!std::is_reference&lt;T&gt;&#123;&#125;, std::<span class="type">nullptr_t</span>&gt; = <span class="literal">nullptr</span>;</span><br></pre></td></tr></table></figure>
<p>è¿™ç§å†™æ³•åˆ©ç”¨äº†std::is_reference<T>{}è¿”å›çš„å¯¹è±¡å¯ä»¥éšå¼è½¬æ¢ä¸ºboolçš„ç‰¹æ€§</p>
<p>æœ€åå¯ä»¥ä¼˜åŒ–æˆè¿™æ ·ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyClass</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">f</span><span class="params">(T <span class="type">const</span>&amp;  x)</span></span>&#123;&#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> T_ = T, <span class="keyword">typename</span> = std::<span class="type">enable_if_t</span>&lt;!std::is_reference_v&lt;T_&gt;&gt;&gt;</span><br><span class="line">  <span class="type">void</span> <span class="built_in">f</span>(T&amp;&amp; x)&#123;&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>æ›´è¿›ä¸€æ­¥åœ°ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">using</span> IsNotReference = std::<span class="type">enable_if_t</span>&lt;!std::is_reference_v&lt;T&gt;&gt;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyClass</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">f</span><span class="params">(T <span class="type">const</span>&amp; x)</span></span>&#123;&#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">template</span>&lt;<span class="keyword">typename</span> T_ = T, <span class="keyword">typename</span> = IsNotReference &lt;T_&gt;&gt;</span><br><span class="line">  <span class="type">void</span> <span class="built_in">f</span>(T&amp;&amp; x)&#123;&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="ğŸ“™-C-20-Conceptsçš„å¼•å…¥"><a href="#ğŸ“™-C-20-Conceptsçš„å¼•å…¥" class="headerlink" title="ğŸ“™ C++20 Conceptsçš„å¼•å…¥"></a>ğŸ“™ C++20 Conceptsçš„å¼•å…¥</h2><p>å°½ç®¡SFINAEåŠŸèƒ½å¼ºå¤§ï¼Œä½†å…¶è¯­æ³•å¤æ‚ï¼Œé”™è¯¯ä¿¡æ¯ä¸ç›´è§‚ï¼Œä¸”å¯è¯»æ€§è¾ƒå·®ã€‚è¿™ä½¿å¾—ä»£ç ç»´æŠ¤å˜å¾—å›°éš¾ï¼Œå°¤å…¶æ˜¯åœ¨å¤§å‹é¡¹ç›®ä¸­ã€‚ä¸ºäº†è§£å†³SFINAEçš„é—®é¢˜ï¼ŒC++20å¼•å…¥äº†Conceptsã€‚Conceptsæä¾›äº†ä¸€ç§æ›´æ¸…æ™°ã€æ›´ç›´è§‚çš„æ–¹å¼æ¥å¯¹æ¨¡æ¿å‚æ•°è¿›è¡Œçº¦æŸ</p>
<p>ä½¿ç”¨Conceptsï¼Œä¸Šè¿°ä»£ç å¯ä»¥é‡å†™ä¸ºï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyClass</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">f</span><span class="params">(<span class="type">const</span> T&amp; x)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å¤„ç† const å¼•ç”¨ç±»å‹</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">f</span><span class="params">(T&amp;&amp; x)</span> <span class="title">requires</span> <span class="params">(!std::is_reference_v&lt;T&gt;)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å¤„ç†éå¼•ç”¨ç±»å‹çš„å³å€¼</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>ä¼˜åŠ¿ï¼š</p>
<ul>
<li>å¯è¯»æ€§æ›´é«˜ï¼šä½¿ç”¨requireså­å¥å¯ä»¥ç›´æ¥åœ¨å‡½æ•°ç­¾åä¸­è¡¨è¾¾çº¦æŸæ¡ä»¶ï¼Œä½¿ä»£ç æ›´æ˜“äºç†è§£</li>
<li>é”™è¯¯ä¿¡æ¯æ›´æ¸…æ™°ï¼šå½“çº¦æŸä¸æ»¡è¶³æ—¶ï¼Œç¼–è¯‘å™¨ä¼šæä¾›æ›´å…·ä½“çš„é”™è¯¯ä¿¡æ¯ï¼Œä¾¿äºè°ƒè¯•</li>
<li>æ›´å¼ºçš„è¡¨è¾¾èƒ½åŠ›ï¼šConceptsæ”¯æŒå¤æ‚çš„é€»è¾‘ç»„åˆï¼Œå¯ä»¥è¡¨è¾¾æ›´ä¸°å¯Œçš„çº¦æŸæ¡ä»¶</li>
</ul>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ol>
<li><a target="_blank" rel="noopener" href="https://www.fluentcpp.com/2018/05/15/make-sfinae-pretty-1-what-value-sfinae-brings-to-code/">what value SFINAE brings to code</a></li>
<li><a target="_blank" rel="noopener" href="https://www.fluentcpp.com/2018/05/18/make-sfinae-pretty-2-hidden-beauty-sfinae/">the hidden beauty of SFINAE</a></li>
<li><a target="_blank" rel="noopener" href="https://shuai.guru/2023-07-08-c-sfinae-to-concepts/">ä»SFINAEåˆ°C++20 Concepts</a></li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://clee01.github.io/2025/04/25/type-traits%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Claark Lee">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hello, my world!">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Hello, my world!">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/04/25/type-traits%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">type traitsç¬”è®°</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-04-25 14:18:18" itemprop="dateCreated datePublished" datetime="2025-04-25T14:18:18+08:00">2025-04-25</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://clee01.github.io/2025/04/25/%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%BA%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Claark Lee">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hello, my world!">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Hello, my world!">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/04/25/%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%BA%90/" class="post-title-link" itemprop="url">å­¦ä¹ èµ„æº</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-04-25 11:38:19 / Modified: 17:41:45" itemprop="dateCreated datePublished" datetime="2025-04-25T11:38:19+08:00">2025-04-25</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <ul>
<li><p><code>C++</code></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/fffaraz/awesome-cpp">awesome-cpp</a></li>
<li><a target="_blank" rel="noopener" href="https://www.fluentcpp.com/">fluentcpp</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/MengRao/tscns">ä¸€ä¸ªtscnsçš„å®ç°</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/MengRao/SPSC_Queue">ä¸€ä¸ªSPSCçš„å®ç°</a></li>
</ul>
</li>
<li><p><code>AI</code></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.anthropic.com/engineering/building-effective-agents">building effective agents</a></li>
</ul>
</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://clee01.github.io/2025/04/25/Quill%E6%BA%90%E7%A0%81%E6%89%AB%E8%AF%BB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Claark Lee">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hello, my world!">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Hello, my world!">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/04/25/Quill%E6%BA%90%E7%A0%81%E6%89%AB%E8%AF%BB/" class="post-title-link" itemprop="url">Quillæºç æ‰«è¯»</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-04-25 00:55:17 / Modified: 14:18:41" itemprop="dateCreated datePublished" datetime="2025-04-25T00:55:17+08:00">2025-04-25</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://clee01.github.io/2025/04/22/fmtlog%E6%BA%90%E7%A0%81%E6%89%AB%E8%AF%BB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Claark Lee">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hello, my world!">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Hello, my world!">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/04/22/fmtlog%E6%BA%90%E7%A0%81%E6%89%AB%E8%AF%BB/" class="post-title-link" itemprop="url">fmtlogæºç æ‰«è¯»</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-04-22 00:19:21" itemprop="dateCreated datePublished" datetime="2025-04-22T00:19:21+08:00">2025-04-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-04-25 15:27:12" itemprop="dateModified" datetime="2025-04-25T15:27:12+08:00">2025-04-25</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="å†™åœ¨æœ€å‰"><a href="#å†™åœ¨æœ€å‰" class="headerlink" title="å†™åœ¨æœ€å‰"></a>å†™åœ¨æœ€å‰</h2><p><a target="_blank" rel="noopener" href="https://github.com/MengRao/fmtlog/tree/308b2317d4e9c21d3b203d104007fde127dcdbfa">fmtlogæºç æ‰«è¯»ç‰ˆæœ¬</a></p>
<h2 id="æ ¸å¿ƒç‰¹ç‚¹"><a href="#æ ¸å¿ƒç‰¹ç‚¹" class="headerlink" title="æ ¸å¿ƒç‰¹ç‚¹"></a>æ ¸å¿ƒç‰¹ç‚¹</h2><ul>
<li><code>SPSC</code>ï¼ˆå•ç”Ÿäº§è€…å•æ¶ˆè´¹è€…ï¼‰æ— é”é˜Ÿåˆ—<ul>
<li>æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„<code>ThreadBuffer</code>ï¼ˆå†…éƒ¨ç»´æŠ¤ä¸€ä¸ª<code>SPSCVarQueue</code>ï¼‰</li>
<li>æ— é”æ“ä½œï¼Œçº³ç§’çº§åˆ«çš„æ“ä½œæ€§èƒ½</li>
</ul>
</li>
<li>æ—¥å¿—æ ¼å¼åŒ–å¼‚æ­¥åŒ–<ul>
<li>æ—¥å¿—æ ¼å¼åŒ–æ˜¯æ…¢æ“ä½œï¼ˆ<code>fmt::format</code>æ˜¯CPUå¯†é›†å‹ï¼‰</li>
<li><code>fmtlog</code>ä¼šæŠŠæ ¼å¼åŒ–æ“ä½œæ”¾åˆ°åå°çº¿ç¨‹ä¸­å¼‚æ­¥æ‰§è¡Œ</li>
<li>å‰ç«¯åªåšç®€å•çš„å‚æ•°ç¼–ç å’Œæ¨å…¥é˜Ÿåˆ—</li>
</ul>
</li>
<li>åç«¯çº¿ç¨‹çš„æœ€å°å †è°ƒåº¦æœºåˆ¶<ul>
<li>åå°çº¿ç¨‹ä»æ‰€æœ‰çº¿ç¨‹çš„é˜Ÿåˆ—ä¸­å–æ—¥å¿—æ—¶ï¼Œä½¿ç”¨ä¸€ä¸ªæœ€å°å †ç»´æŠ¤æ¯ä¸ªçº¿ç¨‹å½“å‰é˜Ÿå¤´çš„æ—¶é—´æˆ³</li>
<li>ç¡®ä¿æ—¥å¿—çš„å…¨å±€æ—¶é—´é¡ºåºæ­£ç¡®ï¼Œä¸”èƒ½ä¿è¯ä¸€å®šç¨‹åº¦çš„å‡åŒ€è°ƒåº¦</li>
</ul>
</li>
<li>è‡ªå®šä¹‰æ—¶é—´æˆ³é‡‡æ ·å™¨<ul>
<li>ä½¿ç”¨<code>RDTSC</code>æŒ‡ä»¤è·å–æ—¶é—´æˆ³ï¼Œæ¯”<code>std::chrono</code>å¿«å¾—å¤š</li>
<li>ç”¨ä¸€ä¸ªè½»é‡çš„æ—¶é—´æ ¡å‡†æœºåˆ¶ï¼ˆ<code>tscns</code>ï¼‰å°†<code>tsc</code>æ˜ å°„ä¸ºçº³ç§’ï¼Œå–ä»£æ…¢é€Ÿç³»ç»Ÿè°ƒç”¨</li>
</ul>
</li>
<li>åˆ·ç›˜ç­–ç•¥åˆç†<ul>
<li>å†™æ–‡ä»¶æ—¶ä¸å¼ºåˆ¶<code>fflush</code>ï¼Œé™¤éï¼š<ul>
<li>æ‰‹åŠ¨è°ƒç”¨<code>poll(true)</code></li>
<li><code>flush</code>è¶…æ—¶åˆ°äº†</li>
</ul>
</li>
<li>é¿å…<code>I/O</code>ç“¶é¢ˆæ‹–æ…¢å†™å…¥çº¿ç¨‹</li>
</ul>
</li>
<li>å†…å­˜é¢„åˆ†é…ï¼šå†…éƒ¨ä½¿ç”¨<code>fmt::MemoryBuffer</code>çš„å¯¹è±¡ç¼“å­˜ï¼Œé¿å…é¢‘ç¹åˆ†é…å’Œé‡Šæ”¾å†…å­˜</li>
<li>ä¸æ‹·è´å†™å…¥ï¼šå‚æ•°ç¼–ç ä¹Ÿä¸éœ€è¦æ ¼å¼åŒ–å­—ç¬¦ä¸²é‚£æ ·çš„å¯¹è±¡ç”Ÿå‘½å‘¨æœŸæ§åˆ¶</li>
<li>å¦‚æœæ²¡æœ‰åˆé€‚çš„å›è°ƒå¤„ç†ï¼Œåœ¨é˜Ÿåˆ—æ»¡çš„åœºæ™¯ä¸‹ä¼šä¸¢æ—¥å¿—</li>
</ul>
<h2 id="æ ¸å¿ƒä»£ç å¸ƒå±€"><a href="#æ ¸å¿ƒä»£ç å¸ƒå±€" class="headerlink" title="æ ¸å¿ƒä»£ç å¸ƒå±€"></a>æ ¸å¿ƒä»£ç å¸ƒå±€</h2><ul>
<li>fmtlog.h<ul>
<li>å¤´æ–‡ä»¶åªæš´éœ²æ¥å£å’Œæ¨¡æ¿å£°æ˜</li>
</ul>
</li>
<li>fmtlog-inl.h<ul>
<li>åŒ…å«æ‰€æœ‰å®ç°ç»†èŠ‚ï¼ŒåŒ…æ‹¬æ¨¡æ¿å®šä¹‰ã€<code>inline</code>å‡½æ•°å®ç°ç­‰</li>
</ul>
</li>
<li>fmtlog.cc<ul>
<li>é€šè¿‡<code>#include &quot;fmtlog-inl.h&quot;</code>æŠŠå®ç°ç¼–è¯‘æˆä¸€ä¸ª.oæ–‡ä»¶ï¼Œä»è€Œæä¾›å¯é€‰çš„é<code>header-only</code>ä½¿ç”¨æ–¹å¼</li>
</ul>
</li>
</ul>
<h2 id="æ ¸å¿ƒç±»UMLå›¾"><a href="#æ ¸å¿ƒç±»UMLå›¾" class="headerlink" title="æ ¸å¿ƒç±»UMLå›¾"></a>æ ¸å¿ƒç±»<code>UML</code>å›¾</h2><p><img src="/images/fmtlog-class-diagram.png"></p>
<h2 id="å…³é”®æµç¨‹"><a href="#å…³é”®æµç¨‹" class="headerlink" title="å…³é”®æµç¨‹"></a>å…³é”®æµç¨‹</h2><ul>
<li><p>å‰ç«¯å¤„ç†<br><img src="/images/fmtlog-frontend.png"></p>
</li>
<li><p>åç«¯å¤„ç†<br><img src="/images/fmtlog-backend.png"></p>
</li>
<li><p>å‰åç«¯äº¤äº’<br><img src="/images/fmtlog-sequence-diagram.png"></p>
</li>
</ul>
<h2 id="ä»£ç æ‰«è¯»"><a href="#ä»£ç æ‰«è¯»" class="headerlink" title="ä»£ç æ‰«è¯»"></a>ä»£ç æ‰«è¯»</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> fmtlogdetail &#123;</span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> Arg&gt;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">UnrefPtr</span> : std::false_type</span><br><span class="line">&#123; <span class="keyword">using</span> type = Arg; &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;&gt;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">UnrefPtr</span>&lt;<span class="type">char</span>*&gt; : std::false_type</span><br><span class="line">&#123; <span class="keyword">using</span> type = <span class="type">char</span>*; &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;&gt;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">UnrefPtr</span>&lt;<span class="type">void</span>*&gt; : std::false_type</span><br><span class="line">&#123; <span class="keyword">using</span> type = <span class="type">void</span>*; &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> Arg&gt;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">UnrefPtr</span>&lt;std::shared_ptr&lt;Arg&gt;&gt; : std::true_type</span><br><span class="line">&#123; <span class="keyword">using</span> type = Arg; &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> Arg, <span class="keyword">typename</span> D&gt;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">UnrefPtr</span>&lt;std::unique_ptr&lt;Arg, D&gt;&gt; : std::true_type</span><br><span class="line">&#123; <span class="keyword">using</span> type = Arg; &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> Arg&gt;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">UnrefPtr</span>&lt;Arg*&gt; : std::true_type</span><br><span class="line">&#123; <span class="keyword">using</span> type = Arg; &#125;;</span><br><span class="line">&#125;; <span class="comment">// namespace fmtlogdetail</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>ä¸Šè¿°ä»£ç å®šä¹‰äº†ä¸€ä¸ªæ¨¡æ¿ç»“æ„ä½“<code>UnrefPtr</code>ï¼Œç”¨äºå¤„ç†æŒ‡é’ˆç±»å‹çš„è§£å¼•ç”¨ã€‚ç¡®å®šä¸€ä¸ªç±»å‹æ˜¯å¦æ˜¯æŒ‡é’ˆç±»å‹ï¼Œå¹¶æä¾›ç›¸åº”çš„åŸºç¡€ç±»å‹</p>
</blockquote>
<hr>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">SPSCVarQueueOPT</span> &#123; ... &#125;;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>SPSCVarQueueOPT</code>æ˜¯ä¸€ä¸ªç»è¿‡ä¼˜åŒ–çš„å•ç”Ÿäº§è€…å•æ¶ˆè´¹è€…å˜é•¿é˜Ÿåˆ—</p>
</blockquote>
<hr>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">TSCNS</span> &#123; ... &#125;;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>TSCNS</code>åœ¨æä¾›é«˜ç²¾åº¦æ—¶é—´æˆ³çš„åŒæ—¶ï¼Œä¿è¯äº†è¾ƒä½çš„æ€§èƒ½å¼€é”€</p>
</blockquote>
<hr>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> Arg&gt;</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">inline</span> <span class="keyword">constexpr</span> <span class="type">bool</span> <span class="title">isNamedArg</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> fmt::detail::is_named_arg&lt;fmt::<span class="type">remove_cvref_t</span>&lt;Arg&gt;&gt;::value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>isNamedArg</code>å‡½æ•°æ¨¡æ¿çš„ä½œç”¨æ˜¯æ£€æŸ¥ç»™å®šçš„æ¨¡æ¿å‚æ•°<code>Arg</code>æ˜¯å¦æ˜¯ä¸€ä¸ªå‘½åå‚æ•°</p>
</blockquote>
<hr>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> Arg&gt;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">unNamedType</span></span><br><span class="line">&#123; <span class="keyword">using</span> type = Arg; &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> Arg&gt;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">unNamedType</span>&lt;fmt::detail::named_arg&lt;<span class="type">char</span>, Arg&gt;&gt;</span><br><span class="line">&#123; <span class="keyword">using</span> type = Arg; &#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> FMT_USE_NONTYPE_TEMPLATE_ARGS</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> Arg, <span class="type">size_t</span> N, fmt::detail::fixed_string&lt;<span class="type">char</span>, N&gt; Str&gt;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">unNamedType</span>&lt;fmt::detail::static_named_arg&lt;Arg, <span class="type">char</span>, N, Str&gt;&gt;</span><br><span class="line">&#123; <span class="keyword">using</span> type = Arg; &#125;;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>unNamedType</code>ç”¨äºä»<code>fmt::format</code>ç›¸å…³çš„æ•°æ®ç»“æ„ä¸­æå–å®é™…ç±»å‹<code>Arg</code></p>
</blockquote>
<hr>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> Arg&gt;</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">inline</span> <span class="keyword">constexpr</span> <span class="type">bool</span> <span class="title">isCstring</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> fmt::detail::mapped_type_constant&lt;Arg, <span class="type">char</span>&gt;::value == fmt::detail::type::cstring_type;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> Arg&gt;</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">inline</span> <span class="keyword">constexpr</span> <span class="type">bool</span> <span class="title">isString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> fmt::detail::mapped_type_constant&lt;Arg, <span class="type">char</span>&gt;::value == fmt::detail::type::string_type;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>å‡½æ•°æ¨¡æ¿<code>isCstring</code>å’Œ<code>isString</code>ç”¨äºæ£€æŸ¥ç‰¹å®šçš„æ¨¡æ¿å‚æ•°<code>Arg</code>æ˜¯å¦æ˜¯ç‰¹å®šç±»å‹çš„å­—ç¬¦ä¸²</p>
</blockquote>
<hr>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> Arg&gt;</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">inline</span> <span class="keyword">constexpr</span> <span class="type">bool</span> <span class="title">needCallDtor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">using</span> ArgType = fmt::<span class="type">remove_cvref_t</span>&lt;Arg&gt;;</span><br><span class="line">    <span class="function"><span class="keyword">if</span> <span class="title">constexpr</span> <span class="params">(isNamedArg&lt;Arg&gt;())</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> needCallDtor&lt;<span class="keyword">typename</span> unNamedType&lt;ArgType&gt;::type&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">if</span> <span class="title">constexpr</span> <span class="params">(isString&lt;Arg&gt;())</span> <span class="keyword">return</span> <span class="literal">false</span></span>;</span><br><span class="line">    <span class="keyword">return</span> !std::is_trivially_destructible&lt;ArgType&gt;::value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>needCallDtor</code>å‡½æ•°æ¨¡æ¿çš„ä½œç”¨æ˜¯åˆ¤æ–­ç»™å®šçš„æ¨¡æ¿å‚æ•°<code>Arg</code>æ˜¯å¦éœ€è¦æ˜¾å¼è°ƒç”¨ææ„å‡½æ•°</p>
</blockquote>
<hr>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="type">size_t</span> CstringIdx&gt;</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">inline</span> <span class="keyword">constexpr</span> <span class="type">char</span>* <span class="title">encodeArgs</span><span class="params">(<span class="type">size_t</span>* cstringSize, <span class="type">char</span>* out)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> out;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="type">size_t</span> CstringIdx, <span class="keyword">typename</span> Arg, <span class="keyword">typename</span>... Args&gt;</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">inline</span> <span class="keyword">constexpr</span> <span class="type">char</span>* <span class="title">encodeArgs</span><span class="params">(<span class="type">size_t</span>* cstringSize, <span class="type">char</span>* out, Arg&amp;&amp; arg,</span></span></span><br><span class="line"><span class="params"><span class="function">                                        Args&amp;&amp;... args)</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">if</span> <span class="title">constexpr</span> <span class="params">(isNamedArg&lt;Arg&gt;())</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">encodeArgs</span>&lt;CstringIdx&gt;(cstringSize, out, arg.value, std::forward&lt;Args&gt;(args)...);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> <span class="built_in">constexpr</span> (<span class="built_in">isCstring</span>&lt;Arg&gt;()) &#123;</span><br><span class="line">        <span class="built_in">memcpy</span>(out, arg, cstringSize[CstringIdx]);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">encodeArgs</span>&lt;CstringIdx + <span class="number">1</span>&gt;(cstringSize, out + cstringSize[CstringIdx],</span><br><span class="line">                                        std::forward&lt;Args&gt;(args)...);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> <span class="built_in">constexpr</span> (<span class="built_in">isString</span>&lt;Arg&gt;()) &#123;</span><br><span class="line">        <span class="type">size_t</span> len = arg.<span class="built_in">size</span>();</span><br><span class="line">        <span class="built_in">memcpy</span>(out, arg.<span class="built_in">data</span>(), len);</span><br><span class="line">        out[len] = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">encodeArgs</span>&lt;CstringIdx&gt;(cstringSize, out + len + <span class="number">1</span>, std::forward&lt;Args&gt;(args)...);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// If Arg has alignment &gt;= 16, gcc could emit aligned move instructions(e.g. movdqa) for</span></span><br><span class="line">        <span class="comment">// placement new even if the *out* is misaligned, which would cause segfault. So we use memcpy</span></span><br><span class="line">        <span class="comment">// when possible</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">constexpr</span> (std::is_trivially_copyable_v&lt;fmt::<span class="type">remove_cvref_t</span>&lt;Arg&gt;&gt;) &#123;</span><br><span class="line">            <span class="built_in">memcpy</span>(out, &amp;arg, <span class="built_in">sizeof</span>(Arg));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">new</span> (out) fmt::<span class="built_in">remove_cvref_t</span>&lt;Arg&gt;(std::forward&lt;Arg&gt;(arg));  <span class="comment">// âš ï¸ï¼ï¼ï¼Risky</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">encodeArgs</span>&lt;CstringIdx&gt;(cstringSize, out + <span class="built_in">sizeof</span>(Arg), std::forward&lt;Args&gt;(args)...);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>encodeArgs</code>ç”¨äºå°†å¯å˜å‚æ•°æ‰“åŒ…æˆä¸€å—è¿ç»­å†…å­˜<code>out</code>ï¼Œä¾›åç»­æ ¼å¼åŒ–æˆ–å»¶è¿Ÿå†™å…¥æ—¶ä½¿ç”¨</p>
</blockquote>
<hr>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="type">size_t</span> Idx, <span class="type">size_t</span> NamedIdx&gt;</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">inline</span> <span class="keyword">constexpr</span> <span class="type">void</span> <span class="title">storeNamedArgs</span><span class="params">(fmt::detail::named_arg_info&lt;<span class="type">char</span>&gt;* named_args_store)</span> </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="type">size_t</span> Idx, <span class="type">size_t</span> NamedIdx, <span class="keyword">typename</span> Arg, <span class="keyword">typename</span>... Args&gt;</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">inline</span> <span class="keyword">constexpr</span> <span class="type">void</span> <span class="title">storeNamedArgs</span><span class="params">(fmt::detail::named_arg_info&lt;<span class="type">char</span>&gt;* named_args_store,</span></span></span><br><span class="line"><span class="params"><span class="function">                                            <span class="type">const</span> Arg&amp; arg, <span class="type">const</span> Args&amp;... args)</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">if</span> <span class="title">constexpr</span> <span class="params">(isNamedArg&lt;Arg&gt;())</span> </span>&#123;</span><br><span class="line">        named_args_store[NamedIdx] = &#123;arg.name, Idx&#125;;</span><br><span class="line">        <span class="built_in">storeNamedArgs</span>&lt;Idx + <span class="number">1</span>, NamedIdx + <span class="number">1</span>&gt;(named_args_store, args...);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">storeNamedArgs</span>&lt;Idx + <span class="number">1</span>, NamedIdx&gt;(named_args_store, args...);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>storeNamedArgs</code>å®ç°äº†å‘½åå‚æ•°çš„å­˜å‚¨åŠŸèƒ½ï¼Œç”¨äºå¤„ç†æ ¼å¼åŒ–å­—ç¬¦ä¸²ä¸­çš„å‘½åå‚æ•°ã€‚å…¶ä¸­ï¼Œ</p>
<ul>
<li>Idx: å½“å‰å¤„ç†çš„å‚æ•°ç´¢å¼•</li>
<li>NamedIdx: å½“å‰å‘½åå‚æ•°çš„ç´¢å¼•ï¼Œä¹Ÿå³æ•°ç»„ç´¢å¼•</li>
<li>named_args_store: å­˜å‚¨å‘½åå‚æ•°ä¿¡æ¯çš„æ•°ç»„</li>
</ul>
</blockquote>
<hr>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="type">bool</span> ValueOnly, <span class="type">size_t</span> Idx, <span class="type">size_t</span> DestructIdx&gt;</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">const</span> <span class="type">char</span>* <span class="title">decodeArgs</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* in, fmt::basic_format_arg&lt;Context&gt;* args,</span></span></span><br><span class="line"><span class="params"><span class="function">                                    <span class="type">const</span> <span class="type">char</span>** destruct_args)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> in;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="type">bool</span> ValueOnly, <span class="type">size_t</span> Idx, <span class="type">size_t</span> DestructIdx, <span class="keyword">typename</span> Arg, <span class="keyword">typename</span>... Args&gt;</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">const</span> <span class="type">char</span>* <span class="title">decodeArgs</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* in, fmt::basic_format_arg&lt;Context&gt;* args,</span></span></span><br><span class="line"><span class="params"><span class="function">                                    <span class="type">const</span> <span class="type">char</span>** destruct_args)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">using</span> <span class="keyword">namespace</span> fmtlogdetail;</span><br><span class="line">    <span class="keyword">using</span> ArgType = fmt::<span class="type">remove_cvref_t</span>&lt;Arg&gt;;</span><br><span class="line">    <span class="function"><span class="keyword">if</span> <span class="title">constexpr</span> <span class="params">(isNamedArg&lt;ArgType&gt;())</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> decodeArgs&lt;ValueOnly, Idx, DestructIdx, <span class="keyword">typename</span> unNamedType&lt;ArgType&gt;::type, Args...&gt;(</span><br><span class="line">        in, args, destruct_args);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> <span class="built_in">constexpr</span> (<span class="built_in">isCstring</span>&lt;Arg&gt;() || <span class="built_in">isString</span>&lt;Arg&gt;()) &#123;</span><br><span class="line">        <span class="type">size_t</span> size = <span class="built_in">strlen</span>(in);</span><br><span class="line">        <span class="function">fmt::string_view <span class="title">v</span><span class="params">(in, size)</span></span>;</span><br><span class="line">        <span class="function"><span class="keyword">if</span> <span class="title">constexpr</span> <span class="params">(ValueOnly)</span> </span>&#123;</span><br><span class="line">            fmt::detail::value&lt;Context&gt;&amp; value_ = *(fmt::detail::value&lt;Context&gt;*)(args + Idx);</span><br><span class="line">            value_ = v;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            args[Idx] = v;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">decodeArgs</span>&lt;ValueOnly, Idx + <span class="number">1</span>, DestructIdx, Args...&gt;(in + size + <span class="number">1</span>, args,</span><br><span class="line">                                                                    destruct_args);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">constexpr</span> (ValueOnly) &#123;</span><br><span class="line">            fmt::detail::value&lt;Context&gt;&amp; value_ = *(fmt::detail::value&lt;Context&gt;*)(args + Idx);</span><br><span class="line">            <span class="function"><span class="keyword">if</span> <span class="title">constexpr</span> <span class="params">(UnrefPtr&lt;ArgType&gt;::value)</span> </span>&#123;</span><br><span class="line">                value_ = **(ArgType*)in;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                value_ = *(ArgType*)in;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">constexpr</span> (UnrefPtr&lt;ArgType&gt;::value) &#123;</span><br><span class="line">                args[Idx] = **(ArgType*)in;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                args[Idx] = *(ArgType*)in;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">if</span> <span class="title">constexpr</span> <span class="params">(needCallDtor&lt;Arg&gt;())</span> </span>&#123;</span><br><span class="line">            destruct_args[DestructIdx] = in;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">decodeArgs</span>&lt;ValueOnly, Idx + <span class="number">1</span>, DestructIdx + <span class="number">1</span>, Args...&gt;(in + <span class="built_in">sizeof</span>(ArgType), args,</span><br><span class="line">                                                                        destruct_args);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">decodeArgs</span>&lt;ValueOnly, Idx + <span class="number">1</span>, DestructIdx, Args...&gt;(in + <span class="built_in">sizeof</span>(ArgType), args,</span><br><span class="line">                                                                        destruct_args);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>decodeArgs</code>ä»ä¸€æ®µè¿ç»­çš„å†…å­˜<code>const char* in</code>ä¸­ï¼ŒæŒ‰æ ¼å¼æŠŠå‚æ•°ååºåˆ—åŒ–å‡ºæ¥ï¼Œæ¢å¤æˆ<code>fmt::basic_format_arg&lt;Context&gt;</code>ç±»å‹çš„æ•°ç»„<code>args</code>ï¼Œä¾›åç»­æ ¼å¼åŒ–è¾“å‡ºä½¿ç”¨</p>
</blockquote>
<p><mark><code>ValueOnly</code>çš„ä½œç”¨</mark></p>
<p>åœ¨<code>fmt</code>åº“ä¸­ï¼Œæ ¼å¼åŒ–å‚æ•°ç±»å‹<code>fmt::basic_format_arg&lt;Context&gt;</code>æœ¬è´¨ä¸Šæ˜¯ä¸ªå°è£…ç»“æ„ï¼Œå†…éƒ¨æœ‰ä¸ª<code>union</code>ï¼Œå«åšï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> Context&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">basic_format_arg</span> &#123;</span><br><span class="line">    detail::value&lt;Context&gt; value_;</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> Context&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">value</span> &#123;</span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line">        monostate no_value;</span><br><span class="line">        ...</span><br><span class="line">    &#125;;</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>detail::value&lt;Context&gt;</code>æ˜¯ä¸€ä¸ª<code>union</code>ï¼Œä»£è¡¨å…·ä½“çš„æ•°æ®å€¼</li>
<li>åœ¨<code>fmtlog</code>ä¸­ï¼Œä¸ºäº†èŠ‚çœå¼€é”€ã€ç»•è¿‡å°è£…ï¼Œå®ƒç›´æ¥ç”¨æŒ‡é’ˆå¼ºè½¬çš„æ–¹å¼è®¿é—®äº†è¿™ä¸ª<code>union</code></li>
</ul>
<hr>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span>... Args&gt;</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">const</span> <span class="type">char</span>* <span class="title">formatTo</span><span class="params">(fmt::string_view format, <span class="type">const</span> <span class="type">char</span>* data, MemoryBuffer&amp; out,</span></span></span><br><span class="line"><span class="params"><span class="function">                            <span class="type">int</span>&amp; argIdx, std::vector&lt;fmt::basic_format_arg&lt;Context&gt;&gt;&amp; args)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">constexpr</span> <span class="type">size_t</span> num_args = <span class="keyword">sizeof</span>...(Args);</span><br><span class="line">    <span class="keyword">constexpr</span> <span class="type">size_t</span> num_dtors = fmt::detail::count&lt;<span class="built_in">needCallDtor</span>&lt;Args&gt;()...&gt;();</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* dtor_args[std::<span class="built_in">max</span>(num_dtors, (<span class="type">size_t</span>)<span class="number">1</span>)];  <span class="comment">// C++ä¸å…è®¸é›¶é•¿æ•°ç»„ã€‚æœ‰äº›ç¼–è¯‘å™¨ä¼šæ¥å—å®ƒä½œä¸ºæ‰©å±•ï¼šç”¨ä½œç»“æ„ä½“å°¾éƒ¨å˜é•¿æ•°æ®å¸ƒå±€</span></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* ret;</span><br><span class="line">    <span class="keyword">if</span> (argIdx &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        argIdx = (<span class="type">int</span>)args.<span class="built_in">size</span>();</span><br><span class="line">        args.<span class="built_in">resize</span>(argIdx + num_args);</span><br><span class="line">        ret = <span class="built_in">decodeArgs</span>&lt;<span class="literal">false</span>, <span class="number">0</span>, <span class="number">0</span>, Args...&gt;(data, args.<span class="built_in">data</span>() + argIdx, dtor_args);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        ret = <span class="built_in">decodeArgs</span>&lt;<span class="literal">true</span>, <span class="number">0</span>, <span class="number">0</span>, Args...&gt;(data, args.<span class="built_in">data</span>() + argIdx, dtor_args);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">vformat_to</span>(out, format, fmt::<span class="built_in">basic_format_args</span>(args.<span class="built_in">data</span>() + argIdx, num_args));</span><br><span class="line">    <span class="built_in">destructArgs</span>&lt;<span class="number">0</span>, Args...&gt;(dtor_args);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>ä»<code>data</code>åºåˆ—åŒ–æ•°æ®ä¸­ååºåˆ—åŒ–å¤šä¸ªå‚æ•°ï¼Œå¡«å…¥<code>args</code>æ•°ç»„ä¸­ï¼Œç”¨äºåç»­<code>fmtlog</code>æ ¼å¼åŒ–ï¼Œå¹¶åœ¨å¿…è¦æ—¶è°ƒç”¨ææ„å‡½æ•°ä»¥ç®¡ç†èµ„æº</p>
</blockquote>
<p><mark><code>argIdx</code>çš„ä½œç”¨</mark></p>
<p>ä¸»è¦ç”¨ä½œçŠ¶æ€æ§åˆ¶ï¼š</p>
<ul>
<li>argIdx &lt; 0: è¡¨ç¤ºç¬¬ä¸€æ¬¡æ ¼å¼åŒ–è¿™äº›å‚æ•°ï¼Œå‚æ•°å°šæœªååºåˆ—åŒ–è¿‡</li>
<li>argIdx &gt;&#x3D; 0: è¡¨ç¤ºè¿™æ‰¹å‚æ•°å·²ç»ååºåˆ—åŒ–è¿‡äº†ï¼Œåªéœ€ä»<code>data</code>é‡Œæ¢å¤<code>value</code>ï¼Œè€Œä¸éœ€è¦é‡æ–°æ„é€ <code>basic_format_arg</code></li>
</ul>
<hr>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="type">bool</span> Reorder, <span class="keyword">typename</span>... Args&gt;</span></span><br><span class="line"><span class="function"><span class="type">static</span> fmt::string_view <span class="title">unNameFormat</span><span class="params">(fmt::string_view in, <span class="type">uint32_t</span>* reorderIdx,</span></span></span><br><span class="line"><span class="params"><span class="function">                                    <span class="type">const</span> Args&amp;... args)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">constexpr</span> <span class="type">size_t</span> num_named_args = fmt::detail::count&lt;<span class="built_in">isNamedArg</span>&lt;Args&gt;()...&gt;();</span><br><span class="line">    <span class="function"><span class="keyword">if</span> <span class="title">constexpr</span> <span class="params">(num_named_args == <span class="number">0</span>)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> in;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* begin = in.<span class="built_in">data</span>();</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* p = begin;</span><br><span class="line">    <span class="function">std::unique_ptr&lt;<span class="type">char</span>[]&gt; <span class="title">unnamed_str</span><span class="params">(<span class="keyword">new</span> <span class="type">char</span>[in.size() + <span class="number">1</span> + num_named_args * <span class="number">5</span>])</span></span>;</span><br><span class="line">    fmt::detail::named_arg_info&lt;<span class="type">char</span>&gt; named_args[std::<span class="built_in">max</span>(num_named_args, (<span class="type">size_t</span>)<span class="number">1</span>)];</span><br><span class="line">    <span class="built_in">storeNamedArgs</span>&lt;<span class="number">0</span>, <span class="number">0</span>&gt;(named_args, args...);</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span>* out = (<span class="type">char</span>*)unnamed_str.<span class="built_in">get</span>();</span><br><span class="line">    <span class="type">uint8_t</span> arg_idx = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="keyword">auto</span> c = *p++;</span><br><span class="line">        <span class="keyword">if</span> (!c) &#123;</span><br><span class="line">            <span class="type">size_t</span> copy_size = p - begin - <span class="number">1</span>;</span><br><span class="line">            <span class="built_in">memcpy</span>(out, begin, copy_size);</span><br><span class="line">            out += copy_size;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (c != <span class="string">&#x27;&#123;&#x27;</span>) <span class="keyword">continue</span>;</span><br><span class="line">        <span class="type">size_t</span> copy_size = p - begin;</span><br><span class="line">        <span class="built_in">memcpy</span>(out, begin, copy_size);</span><br><span class="line">        out += copy_size;</span><br><span class="line">        begin = p;</span><br><span class="line">        c = *p++;</span><br><span class="line">        <span class="keyword">if</span> (!c) fmt::<span class="built_in">report_error</span>(<span class="string">&quot;invalid format string&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (fmt::detail::<span class="built_in">is_name_start</span>(c)) &#123;</span><br><span class="line">            <span class="keyword">while</span> ((fmt::detail::<span class="built_in">is_name_start</span>(c = *p) || (<span class="string">&#x27;0&#x27;</span> &lt;= c &amp;&amp; c &lt;= <span class="string">&#x27;9&#x27;</span>))) &#123;</span><br><span class="line">                ++p;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="function">fmt::string_view <span class="title">name</span><span class="params">(begin, p - begin)</span></span>;</span><br><span class="line">            <span class="type">int</span> id = <span class="number">-1</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; num_named_args; ++i) &#123;</span><br><span class="line">                <span class="keyword">if</span> (named_args[i].name == name) &#123;</span><br><span class="line">                id = named_args[i].id;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (id &lt; <span class="number">0</span>) fmt::<span class="built_in">report_error</span>(<span class="string">&quot;invalid format string&quot;</span>);</span><br><span class="line">            <span class="function"><span class="keyword">if</span> <span class="title">constexpr</span> <span class="params">(Reorder)</span> </span>&#123;</span><br><span class="line">                reorderIdx[id] = arg_idx++;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                out = fmt::format_to(out, <span class="string">&quot;&#123;&#125;&quot;</span>, id);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            *out++ = c;</span><br><span class="line">        &#125;</span><br><span class="line">        begin = p;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* ptr = unnamed_str.<span class="built_in">release</span>();</span><br><span class="line">    <span class="keyword">return</span> fmt::<span class="built_in">string_view</span>(ptr, out - ptr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>unNameFormat</code>ç”¨äºå°†å‘½åå‚æ•°æ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼ˆå¦‚<code>&#123;name&#125;</code>ï¼‰è½¬æ¢æˆä½ç½®å‚æ•°æ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼ˆå¦‚<code>&#123;0&#125;</code>ã€<code>&#123;1&#125;</code>ï¼‰ï¼Œä»¥ä¾¿äºåç»­æ›´å¿«æ ¼å¼åŒ–æˆ–è¿›è¡Œå‚æ•°é‡æ’ã€‚å…¶ä¸­ï¼š</p>
<ul>
<li>Reorder &#x3D;&#x3D; false: æŠŠ<code>&#123;name&#125;</code>è½¬æ¢æˆ<code>&#123;id&#125;</code>ï¼ˆæ•°å­—ç¼–å·ï¼‰</li>
<li>Reorder &#x3D;&#x3D; true: åªæå–æ¯ä¸ªå‘½åå‚æ•°å‡ºç°é¡ºåºï¼Œå¡«å…¥<code>reorderIdx</code>æ˜ å°„è¡¨ï¼Œä¼šæŠŠ<code>&#123;name&#125;</code>è½¬æ¢æˆ<code>&#123;&#125;</code></li>
</ul>
</blockquote>
<hr>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span>... Args&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">log</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="type">uint32_t</span>&amp; logId, <span class="type">int64_t</span> tsc, <span class="type">const</span> <span class="type">char</span>* location, LogLevel level,</span></span></span><br><span class="line"><span class="params"><span class="function">fmt::format_string&lt;<span class="keyword">typename</span> fmtlogdetail::UnrefPtr&lt;fmt::<span class="type">remove_cvref_t</span>&lt;Args&gt;&gt;::type...&gt; format,</span></span></span><br><span class="line"><span class="params"><span class="function">Args&amp;&amp;... args)</span> <span class="keyword">noexcept</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!logId) &#123;</span><br><span class="line">        <span class="keyword">auto</span> unnamed_format = <span class="built_in">unNameFormat</span>&lt;<span class="literal">false</span>&gt;(fmt::<span class="built_in">string_view</span>(format), <span class="literal">nullptr</span>, args...);</span><br><span class="line">        <span class="built_in">registerLogInfo</span>(logId, formatTo&lt;Args...&gt;, location, level, unnamed_format);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">constexpr</span> <span class="type">size_t</span> num_cstring = fmt::detail::count&lt;<span class="built_in">isCstring</span>&lt;Args&gt;()...&gt;();</span><br><span class="line">    <span class="type">size_t</span> cstringSizes[std::<span class="built_in">max</span>(num_cstring, (<span class="type">size_t</span>)<span class="number">1</span>)];</span><br><span class="line">    <span class="type">uint32_t</span> alloc_size = <span class="number">8</span> + (<span class="type">uint32_t</span>)<span class="built_in">getArgSizes</span>&lt;<span class="number">0</span>&gt;(cstringSizes, args...);</span><br><span class="line">    <span class="type">bool</span> q_full_cb = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">auto</span> header = <span class="built_in">allocMsg</span>(alloc_size, q_full_cb)) &#123;</span><br><span class="line">            header-&gt;logId = logId;</span><br><span class="line">            <span class="type">char</span>* out = (<span class="type">char</span>*)(header + <span class="number">1</span>);</span><br><span class="line">            *(<span class="type">int64_t</span>*)out = tsc;</span><br><span class="line">            out += <span class="number">8</span>;</span><br><span class="line">            <span class="built_in">encodeArgs</span>&lt;<span class="number">0</span>&gt;(cstringSizes, out, std::forward&lt;Args&gt;(args)...);</span><br><span class="line">            header-&gt;<span class="built_in">push</span>(alloc_size);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        q_full_cb = <span class="literal">false</span>;</span><br><span class="line">    &#125; <span class="keyword">while</span> (FMTLOG_BLOCK);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å‚æ•°ï¼š</p>
<ul>
<li>logId: æ—¥å¿—æ ¼å¼åœ¨ç³»ç»Ÿä¸­çš„å”¯ä¸€IDï¼Œåˆå§‹ä¸º0</li>
<li>tsc: é«˜ç²¾åº¦æ—¶é—´æˆ³</li>
<li>location: æ—¥å¿—ä½ç½®ï¼ˆå¦‚main.cpp:100ï¼‰</li>
<li>level: æ—¥å¿—çº§åˆ«</li>
<li>format: æ ¼å¼å­—ç¬¦ä¸²ï¼Œå¸¦ç±»å‹æ£€æŸ¥ï¼ˆfmt::format_string&lt;&gt;ï¼‰</li>
<li>argsâ€¦: æ—¥å¿—å†…å®¹</li>
</ul>
<p>æ­¥éª¤ï¼š</p>
<ul>
<li>é¦–æ¬¡æ³¨å†Œæ—¥å¿—æ ¼å¼ï¼ˆä¸€æ¬¡æ€§æ“ä½œï¼‰</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!logId) &#123;</span><br><span class="line">  <span class="keyword">auto</span> unnamed_format = <span class="built_in">unNameFormat</span>&lt;<span class="literal">false</span>&gt;(fmt::<span class="built_in">string_view</span>(format), <span class="literal">nullptr</span>, args...);  <span class="comment">// å°†æ ¼å¼ä¸²ä¸­çš„å‘½åå‚æ•°è½¬ä¸ºä½ç½®å‚æ•°ï¼Œæ¯”å¦‚&#123;0&#125;ã€&#123;1&#125;ï¼Œæé«˜åç»­æ ¼å¼åŒ–é€Ÿåº¦</span></span><br><span class="line">  <span class="built_in">registerLogInfo</span>(logId, formatTo&lt;Args...&gt;, location, level, unnamed_format);  <span class="comment">// æ³¨å†Œæ ¼å¼å‡½æ•°formatTo</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>å¤„ç†Cå­—ç¬¦ä¸²å‚æ•°</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">constexpr</span> <span class="type">size_t</span> num_cstring = fmt::detail::count&lt;<span class="built_in">isCstring</span>&lt;Args&gt;()...&gt;();</span><br><span class="line"><span class="type">size_t</span> cstringSizes[std::<span class="built_in">max</span>(num_cstring, (<span class="type">size_t</span>)<span class="number">1</span>)];  <span class="comment">// å®šä¹‰Cå­—ç¬¦ä¸²é•¿åº¦ æ•°ç»„ cstringSizes</span></span><br></pre></td></tr></table></figure>
<ul>
<li>è®¡ç®—æ—¥å¿—æ¶ˆæ¯å ç”¨ç©ºé—´</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">uint32_t</span> alloc_size = <span class="number">8</span> + (<span class="type">uint32_t</span>)<span class="built_in">getArgSizes</span>&lt;<span class="number">0</span>&gt;(cstringSizes, args...);  <span class="comment">// 8å­—èŠ‚ç”¨äºtsc</span></span><br></pre></td></tr></table></figure>
<ul>
<li>å¾€æ—¥å¿—ç¼“å†²åŒºå†™å…¥æ—¥å¿—å†…å®¹</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">bool</span> q_full_cb = <span class="literal">true</span>;</span><br><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">auto</span> header = <span class="built_in">allocMsg</span>(alloc_size, q_full_cb)) &#123;  <span class="comment">// ä»æ—¥å¿—ç¼“å†²åŒºç”³è¯·ç©ºé—´ï¼ˆæœ‰å¯èƒ½å¤±è´¥ï¼Œæ¯”å¦‚é˜Ÿåˆ—æ»¡ï¼‰</span></span><br><span class="line">    header-&gt;logId = logId;</span><br><span class="line">    <span class="type">char</span>* out = (<span class="type">char</span>*)(header + <span class="number">1</span>);  <span class="comment">// header + 1æŒ‡å‘æ­£æ–‡éƒ¨åˆ†</span></span><br><span class="line">    *(<span class="type">int64_t</span>*)out = tsc;</span><br><span class="line">    out += <span class="number">8</span>;</span><br><span class="line">    <span class="built_in">encodeArgs</span>&lt;<span class="number">0</span>&gt;(cstringSizes, out, std::forward&lt;Args&gt;(args)...);</span><br><span class="line">    header-&gt;<span class="built_in">push</span>(alloc_size);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  q_full_cb = <span class="literal">false</span>;</span><br><span class="line">&#125; <span class="keyword">while</span> (FMTLOG_BLOCK);  <span class="comment">// FMTLOG_BLOCK = 1: å¾ªç¯ç­‰å¾…ç›´åˆ°æˆåŠŸï¼ˆé˜»å¡æ¨¡å¼ï¼‰ï¼›åä¹‹ï¼Œåªå°è¯•ä¸€æ¬¡ï¼ˆéé˜»å¡æ¨¡å¼ï¼Œä¸¢å¼ƒæ—¥å¿—ï¼‰</span></span><br></pre></td></tr></table></figure>

<hr>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span>... Args&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">logOnce</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* location, LogLevel level, fmt::format_string&lt;Args...&gt; format,</span></span></span><br><span class="line"><span class="params"><span class="function">                    Args&amp;&amp;... args)</span> </span>&#123;</span><br><span class="line"><span class="function">fmt::string_view <span class="title">sv</span><span class="params">(format)</span></span>;</span><br><span class="line"><span class="keyword">auto</span>&amp;&amp; fmt_args = fmt::<span class="built_in">make_format_args</span>(args...);</span><br><span class="line"><span class="type">uint32_t</span> fmt_size = formatted_size(sv, fmt_args);</span><br><span class="line"><span class="type">uint32_t</span> alloc_size = <span class="number">8</span> + <span class="number">8</span> + fmt_size;</span><br><span class="line"><span class="type">bool</span> q_full_cb = <span class="literal">true</span>;</span><br><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">auto</span> header = <span class="built_in">allocMsg</span>(alloc_size, q_full_cb)) &#123;</span><br><span class="line">        header-&gt;logId = (<span class="type">uint32_t</span>)level;</span><br><span class="line">        <span class="type">char</span>* out = (<span class="type">char</span>*)(header + <span class="number">1</span>);</span><br><span class="line">        *(<span class="type">int64_t</span>*)out = tscns.<span class="built_in">rdtsc</span>();</span><br><span class="line">        out += <span class="number">8</span>;</span><br><span class="line">        *(<span class="type">const</span> <span class="type">char</span>**)out = location;</span><br><span class="line">        out += <span class="number">8</span>;</span><br><span class="line">        <span class="built_in">vformat_to</span>(out, sv, fmt_args);</span><br><span class="line">        header-&gt;<span class="built_in">push</span>(alloc_size);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    q_full_cb = <span class="literal">false</span>;</span><br><span class="line">&#125; <span class="keyword">while</span> (FMTLOG_BLOCK);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å‚æ•°ï¼š</p>
<ul>
<li>location: æ—¥å¿—ä½ç½®ï¼ˆå¦‚main.cpp:100ï¼‰</li>
<li>level: æ—¥å¿—çº§åˆ«</li>
<li>format: æ ¼å¼å­—ç¬¦ä¸²ï¼Œå¸¦ç±»å‹æ£€æŸ¥ï¼ˆfmt::format_string&lt;&gt;ï¼‰</li>
<li>argsâ€¦: æ—¥å¿—å†…å®¹</li>
</ul>
<p>æ­¥éª¤ï¼š</p>
<ul>
<li>è®¡ç®—æ ¼å¼åŒ–ç»“æœå­—èŠ‚æ•°</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">uint32_t</span> fmt_size = formatted_size(sv, fmt_args);</span><br><span class="line"><span class="type">uint32_t</span> alloc_size = <span class="number">8</span> + <span class="number">8</span> + fmt_size;  <span class="comment">// æ—¶é—´æˆ³ + locationå­—ç¬¦ä¸²æŒ‡é’ˆ + æ ¼å¼åŒ–å¥½çš„å­—ç¬¦ä¸²å†…å®¹</span></span><br></pre></td></tr></table></figure>
<ul>
<li>å†™å…¥æ—¥å¿—å†…å®¹</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">header-&gt;logId = (<span class="type">uint32_t</span>)level;</span><br><span class="line"><span class="type">char</span>* out = (<span class="type">char</span>*)(header + <span class="number">1</span>);</span><br><span class="line">*(<span class="type">int64_t</span>*)out = tscns.<span class="built_in">rdtsc</span>();</span><br><span class="line">out += <span class="number">8</span>;</span><br><span class="line">*(<span class="type">const</span> <span class="type">char</span>**)out = location;</span><br><span class="line">out += <span class="number">8</span>;</span><br><span class="line"><span class="built_in">vformat_to</span>(out, sv, fmt_args);  <span class="comment">// å†™å…¥æ ¼å¼åŒ–åçš„å†…å®¹</span></span><br></pre></td></tr></table></figure>

<hr>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> __FMTLOG_S1(x) #x</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __FMTLOG_S2(x) __FMTLOG_S1(x)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __FMTLOG_LOCATION __FILE__ <span class="string">&quot;:&quot;</span> __FMTLOG_S2(__LINE__)</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>å®å®šä¹‰<code>__FMTLOG_LOCATION</code>æ„é€ ä»£ç è¡Œå· + æ–‡ä»¶åçš„ä¿¡æ¯ï¼Œå¯ä»¥æ’å…¥åˆ°æ—¥å¿—ä¸­è¿½è¸ªæ¥æº</p>
</blockquote>
<hr>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">setHeaderPattern</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* pattern)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (shouldDeallocateHeader) <span class="keyword">delete</span>[] headerPattern.<span class="built_in">data</span>();</span><br><span class="line">    <span class="keyword">using</span> <span class="keyword">namespace</span> fmt::literals;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; parttenArgSize; i++) &#123;</span><br><span class="line">        reorderIdx[i] = parttenArgSize - <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    headerPattern = fmtlog::<span class="built_in">unNameFormat</span>&lt;<span class="literal">true</span>&gt;(</span><br><span class="line">        pattern, reorderIdx, <span class="string">&quot;a&quot;</span>_a = <span class="string">&quot;&quot;</span>, <span class="string">&quot;b&quot;</span>_a = <span class="string">&quot;&quot;</span>, <span class="string">&quot;C&quot;</span>_a = <span class="string">&quot;&quot;</span>, <span class="string">&quot;Y&quot;</span>_a = <span class="string">&quot;&quot;</span>, <span class="string">&quot;m&quot;</span>_a = <span class="string">&quot;&quot;</span>, <span class="string">&quot;d&quot;</span>_a = <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;t&quot;</span>_a = <span class="string">&quot;thread name&quot;</span>, <span class="string">&quot;F&quot;</span>_a = <span class="string">&quot;&quot;</span>, <span class="string">&quot;f&quot;</span>_a = <span class="string">&quot;&quot;</span>, <span class="string">&quot;e&quot;</span>_a = <span class="string">&quot;&quot;</span>, <span class="string">&quot;S&quot;</span>_a = <span class="string">&quot;&quot;</span>, <span class="string">&quot;M&quot;</span>_a = <span class="string">&quot;&quot;</span>, <span class="string">&quot;H&quot;</span>_a = <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;l&quot;</span>_a = fmtlog::<span class="built_in">LogLevel</span>(), <span class="string">&quot;s&quot;</span>_a = <span class="string">&quot;fmtlog.cc:123&quot;</span>, <span class="string">&quot;g&quot;</span>_a = <span class="string">&quot;/home/raomeng/fmtlog/fmtlog.cc:123&quot;</span>, <span class="string">&quot;Ymd&quot;</span>_a = <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;HMS&quot;</span>_a = <span class="string">&quot;&quot;</span>, <span class="string">&quot;HMSe&quot;</span>_a = <span class="string">&quot;&quot;</span>, <span class="string">&quot;HMSf&quot;</span>_a = <span class="string">&quot;&quot;</span>, <span class="string">&quot;HMSF&quot;</span>_a = <span class="string">&quot;&quot;</span>, <span class="string">&quot;YmdHMS&quot;</span>_a = <span class="string">&quot;&quot;</span>, <span class="string">&quot;YmdHMSe&quot;</span>_a = <span class="string">&quot;&quot;</span>, <span class="string">&quot;YmdHMSf&quot;</span>_a = <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;YmdHMSF&quot;</span>_a = <span class="string">&quot;&quot;</span>);</span><br><span class="line">    shouldDeallocateHeader = headerPattern.<span class="built_in">data</span>() != pattern;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">setArg</span>&lt;<span class="number">0</span>&gt;(fmt::<span class="built_in">string_view</span>(weekdayName.s, <span class="number">3</span>));</span><br><span class="line">    <span class="built_in">setArg</span>&lt;<span class="number">1</span>&gt;(fmt::<span class="built_in">string_view</span>(monthName.s, <span class="number">3</span>));</span><br><span class="line">    <span class="built_in">setArg</span>&lt;<span class="number">2</span>&gt;(fmt::<span class="built_in">string_view</span>(&amp;year[<span class="number">2</span>], <span class="number">2</span>));</span><br><span class="line">    <span class="built_in">setArg</span>&lt;<span class="number">3</span>&gt;(fmt::<span class="built_in">string_view</span>(year.s, <span class="number">4</span>));</span><br><span class="line">    <span class="built_in">setArg</span>&lt;<span class="number">4</span>&gt;(fmt::<span class="built_in">string_view</span>(month.s, <span class="number">2</span>));</span><br><span class="line">    <span class="built_in">setArg</span>&lt;<span class="number">5</span>&gt;(fmt::<span class="built_in">string_view</span>(day.s, <span class="number">2</span>));</span><br><span class="line">    <span class="built_in">setArg</span>&lt;<span class="number">6</span>&gt;(fmt::<span class="built_in">string_view</span>());</span><br><span class="line">    <span class="built_in">setArg</span>&lt;<span class="number">7</span>&gt;(fmt::<span class="built_in">string_view</span>(nanosecond.s, <span class="number">9</span>));</span><br><span class="line">    <span class="built_in">setArg</span>&lt;<span class="number">8</span>&gt;(fmt::<span class="built_in">string_view</span>(nanosecond.s, <span class="number">6</span>));</span><br><span class="line">    <span class="built_in">setArg</span>&lt;<span class="number">9</span>&gt;(fmt::<span class="built_in">string_view</span>(nanosecond.s, <span class="number">3</span>));</span><br><span class="line">    <span class="built_in">setArg</span>&lt;<span class="number">10</span>&gt;(fmt::<span class="built_in">string_view</span>(second.s, <span class="number">2</span>));</span><br><span class="line">    <span class="built_in">setArg</span>&lt;<span class="number">11</span>&gt;(fmt::<span class="built_in">string_view</span>(minute.s, <span class="number">2</span>));</span><br><span class="line">    <span class="built_in">setArg</span>&lt;<span class="number">12</span>&gt;(fmt::<span class="built_in">string_view</span>(hour.s, <span class="number">2</span>));</span><br><span class="line">    <span class="built_in">setArg</span>&lt;<span class="number">13</span>&gt;(fmt::<span class="built_in">string_view</span>(logLevel.s, <span class="number">3</span>));</span><br><span class="line">    <span class="built_in">setArg</span>&lt;<span class="number">14</span>&gt;(fmt::<span class="built_in">string_view</span>());</span><br><span class="line">    <span class="built_in">setArg</span>&lt;<span class="number">15</span>&gt;(fmt::<span class="built_in">string_view</span>());</span><br><span class="line">    <span class="built_in">setArg</span>&lt;<span class="number">16</span>&gt;(fmt::<span class="built_in">string_view</span>(year.s, <span class="number">10</span>)); <span class="comment">// Ymd</span></span><br><span class="line">    <span class="built_in">setArg</span>&lt;<span class="number">17</span>&gt;(fmt::<span class="built_in">string_view</span>(hour.s, <span class="number">8</span>));  <span class="comment">// HMS</span></span><br><span class="line">    <span class="built_in">setArg</span>&lt;<span class="number">18</span>&gt;(fmt::<span class="built_in">string_view</span>(hour.s, <span class="number">12</span>)); <span class="comment">// HMSe</span></span><br><span class="line">    <span class="built_in">setArg</span>&lt;<span class="number">19</span>&gt;(fmt::<span class="built_in">string_view</span>(hour.s, <span class="number">15</span>)); <span class="comment">// HMSf</span></span><br><span class="line">    <span class="built_in">setArg</span>&lt;<span class="number">20</span>&gt;(fmt::<span class="built_in">string_view</span>(hour.s, <span class="number">18</span>)); <span class="comment">// HMSF</span></span><br><span class="line">    <span class="built_in">setArg</span>&lt;<span class="number">21</span>&gt;(fmt::<span class="built_in">string_view</span>(year.s, <span class="number">19</span>));   <span class="comment">// YmdHMS</span></span><br><span class="line">    <span class="built_in">setArg</span>&lt;<span class="number">22</span>&gt;(fmt::<span class="built_in">string_view</span>(year.s, <span class="number">23</span>));   <span class="comment">// YmdHMSe</span></span><br><span class="line">    <span class="built_in">setArg</span>&lt;<span class="number">23</span>&gt;(fmt::<span class="built_in">string_view</span>(year.s, <span class="number">26</span>));   <span class="comment">// YmdHMSf</span></span><br><span class="line">    <span class="built_in">setArg</span>&lt;<span class="number">24</span>&gt;(fmt::<span class="built_in">string_view</span>(year.s, <span class="number">29</span>));   <span class="comment">// YmdHMSF</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ­¥éª¤ï¼š</p>
<ul>
<li>æ—§èµ„æºé‡Šæ”¾é€»è¾‘<ul>
<li>å¦‚æœä¹‹å‰è®¾ç½®è¿‡<code>header pattern</code>ï¼ˆå¹¶åŠ¨æ€åˆ†é…äº†å†…å­˜ï¼‰ï¼Œå…ˆé‡Šæ”¾æ—§èµ„æºï¼Œé¿å…å†…å­˜æ³„æ¼</li>
</ul>
</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (shouldDeallocateHeader) <span class="keyword">delete</span>[] headerPattern.<span class="built_in">data</span>();</span><br></pre></td></tr></table></figure>
<ul>
<li>åˆå§‹åŒ–é‡æ’ç´¢å¼•è¡¨</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; parttenArgSize; i++) &#123;</span><br><span class="line">  reorderIdx[i] = parttenArgSize - <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>å¤„ç†æ ¼å¼ä¸²<ul>
<li>æŠŠå¸¦å‘½åå‚æ•°çš„æ ¼å¼ä¸²ï¼ˆå¦‚<code>&#123;H&#125;:&#123;M&#125;:&#123;S&#125;</code>ï¼‰æ›¿æ¢æˆåŒ¿åå‚æ•°ï¼ˆå¦‚<code>&#123;&#125;:&#123;&#125;:&#123;&#125;</code>ï¼‰ï¼ŒåŒæ—¶å¡«å……<code>reorderIdx</code></li>
<li><code>&quot;_a = &quot;</code>æ˜¯<code>fmt</code>æä¾›çš„å‘½åå‚æ•°ç»‘å®šè¯­æ³•</li>
</ul>
</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">headerPattern = fmtlog::<span class="built_in">unNameFormat</span>&lt;<span class="literal">true</span>&gt;(</span><br><span class="line">  pattern, reorderIdx,</span><br><span class="line">  <span class="string">&quot;a&quot;</span>_a = <span class="string">&quot;&quot;</span>, <span class="string">&quot;b&quot;</span>_a = <span class="string">&quot;&quot;</span>, ..., <span class="string">&quot;YmdHMSF&quot;</span>_a = <span class="string">&quot;&quot;</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<ul>
<li>æ ‡è®°æ˜¯å¦éœ€è¦é‡Šæ”¾<code>headerPattern</code></li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shouldDeallocateHeader = headerPattern.<span class="built_in">data</span>() != pattern;</span><br></pre></td></tr></table></figure>
<ul>
<li>è®¾ç½®æ ¼å¼åŒ–å˜é‡<ul>
<li><code>setArg&lt;N&gt;()</code>ç»™ä½ç½®å ä½ç¬¦ç»‘å®šå®é™…å†…å®¹åœ°å€</li>
</ul>
</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">setArg</span>&lt;<span class="number">0</span>&gt;(fmt::<span class="built_in">string_view</span>(weekdayName.s, <span class="number">3</span>));</span><br><span class="line">...</span><br><span class="line"><span class="built_in">setArg</span>&lt;<span class="number">24</span>&gt;(fmt::<span class="built_in">string_view</span>(year.s, <span class="number">29</span>));</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="type">size_t</span> I, <span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">setArg</span><span class="params">(<span class="type">const</span> T&amp; arg)</span> </span>&#123;</span><br><span class="line">    args[reorderIdx[I]] = arg;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">StaticLogInfo</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">constexpr</span> <span class="title">StaticLogInfo</span><span class="params">(fmtlog::FormatToFn fn, <span class="type">const</span> <span class="type">char</span>* loc, fmtlog::LogLevel level, fmt::string_view fmtString)</span></span></span><br><span class="line"><span class="function">        : formatToFn(fn)</span></span><br><span class="line"><span class="function">        , formatString(fmtString)</span></span><br><span class="line"><span class="function">        , location(loc)</span></span><br><span class="line"><span class="function">        , logLevel(level)</span></span><br><span class="line"><span class="function">        , argIdx(<span class="number">-1</span>) &#123;</span>&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">processLocation</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="type">size_t</span> size = <span class="built_in">strlen</span>(location);</span><br><span class="line">        <span class="type">const</span> <span class="type">char</span>* p = location + size;</span><br><span class="line">        <span class="keyword">if</span> (size &gt; <span class="number">255</span>) &#123;</span><br><span class="line">            location = p - <span class="number">255</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        endPos = p - location;</span><br><span class="line">        <span class="type">const</span> <span class="type">char</span>* base = location;</span><br><span class="line">        <span class="keyword">while</span> (p &gt; location) &#123;</span><br><span class="line">            <span class="type">char</span> c = *--p;</span><br><span class="line">            <span class="keyword">if</span> (c == <span class="string">&#x27;/&#x27;</span> || c == <span class="string">&#x27;\\&#x27;</span>) &#123;</span><br><span class="line">                base = p + <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        basePos = base - location;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">inline</span> fmt::string_view <span class="title">getBase</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> fmt::<span class="built_in">string_view</span>(location + basePos, endPos - basePos); &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">inline</span> fmt::string_view <span class="title">getLocation</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> fmt::<span class="built_in">string_view</span>(location, endPos); &#125;</span><br><span class="line"></span><br><span class="line">    fmtlog::FormatToFn formatToFn;</span><br><span class="line">    fmt::string_view formatString;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* location;</span><br><span class="line">    <span class="type">uint8_t</span> basePos;</span><br><span class="line">    <span class="type">uint8_t</span> endPos;</span><br><span class="line">    fmtlog::LogLevel logLevel;</span><br><span class="line">    <span class="type">int</span> argIdx;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>StaticLogInfo</code>ç”¨æ¥ç¼“å­˜æ—¥å¿—ç‚¹çš„é™æ€ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ ¼å¼åŒ–å‡½æ•°ã€æ—¥å¿—çº§åˆ«ã€æºæ–‡ä»¶ä½ç½®ç­‰</li>
<li>ç»“æ„ä½“æˆå‘˜åŠŸèƒ½</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">StaticLogInfo</span> &#123;</span><br><span class="line">  fmtlog::FormatToFn formatToFn;   <span class="comment">// æ ¼å¼åŒ–å‡½æ•°æŒ‡é’ˆï¼ˆå°†å‚æ•°è½¬ä¸ºå­—ç¬¦ä¸²ï¼‰</span></span><br><span class="line">  fmt::string_view formatString;   <span class="comment">// æ—¥å¿—æ ¼å¼å­—ç¬¦ä¸²</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span>* location;            <span class="comment">// æ—¥å¿—æ‰€åœ¨çš„ä»£ç ä½ç½®ï¼ˆå¦‚&quot;main.cpp:123&quot;ï¼‰</span></span><br><span class="line">  <span class="type">uint8_t</span> basePos;                 <span class="comment">// æ–‡ä»¶è·¯å¾„æœ€åçš„æ–‡ä»¶åéƒ¨åˆ†çš„èµ·å§‹ä½ç½®</span></span><br><span class="line">  <span class="type">uint8_t</span> endPos;                  <span class="comment">// æ–‡ä»¶è·¯å¾„æ€»é•¿åº¦ï¼ˆæœ€å¤š255ï¼‰</span></span><br><span class="line">  fmtlog::LogLevel logLevel;       <span class="comment">// æ—¥å¿—çº§åˆ«ï¼ˆæ¯”å¦‚infoã€debugï¼‰</span></span><br><span class="line">  <span class="type">int</span> argIdx;                      <span class="comment">// å‚æ•°ç´¢å¼•ï¼ˆé»˜è®¤-1ï¼‰</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<hr>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">preallocate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (fmtlog::threadBuffer) <span class="keyword">return</span>;</span><br><span class="line">    fmtlog::threadBuffer = <span class="keyword">new</span> fmtlog::<span class="built_in">ThreadBuffer</span>();</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _WIN32</span></span><br><span class="line">    <span class="type">uint32_t</span> tid = <span class="built_in">static_cast</span>&lt;<span class="type">uint32_t</span>&gt;(::<span class="built_in">GetCurrentThreadId</span>());</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="type">uint32_t</span> tid = <span class="built_in">static_cast</span>&lt;<span class="type">uint32_t</span>&gt;(::<span class="built_in">syscall</span>(SYS_gettid));</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    fmtlog::threadBuffer-&gt;nameSize =</span><br><span class="line">        fmt::format_to_n(fmtlog::threadBuffer-&gt;name, <span class="built_in">sizeof</span>(fmtlog::threadBuffer-&gt;name), <span class="string">&quot;&#123;&#125;&quot;</span>, tid).size;</span><br><span class="line">    sbc.<span class="built_in">threadBufferCreated</span>();</span><br><span class="line"></span><br><span class="line">    <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">guard</span><span class="params">(bufferMutex)</span></span>;</span><br><span class="line">    threadBuffers.<span class="built_in">push_back</span>(fmtlog::threadBuffer);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>ä¸ºå½“å‰çº¿ç¨‹åˆ†é…å¹¶åˆå§‹åŒ–<code>ThreadBuffer</code></li>
<li>å°†å½“å‰çº¿ç¨‹IDä½œä¸ºåå­—å†™å…¥ç¼“å†²åŒº</li>
<li>é€šçŸ¥<code>ThreadBufferDestroyer</code>çº¿ç¨‹ç¼“å†²åŒºå·²åˆ›å»º</li>
<li>æŠŠè¯¥çº¿ç¨‹ç¼“å†²åŒºæ”¾å…¥å…¨å±€åˆ—è¡¨ï¼Œä¾›<code>fmtlog</code>ç»Ÿä¸€ç®¡ç†</li>
</ul>
<hr>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">flushLogFile</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (outputFp) &#123;</span><br><span class="line">        <span class="built_in">fwrite</span>(membuf.<span class="built_in">data</span>(), <span class="number">1</span>, membuf.<span class="built_in">size</span>(), outputFp);</span><br><span class="line">        <span class="keyword">if</span> (!manageFp) <span class="built_in">fflush</span>(outputFp);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            fpos += membuf.<span class="built_in">size</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    membuf.<span class="built_in">clear</span>();</span><br><span class="line">    nextFlushTime = (std::numeric_limits&lt;<span class="type">int64_t</span>&gt;::max)();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>fwrite</code>æŠŠå†…å­˜ç¼“å†²åŒº<code>membuf</code>ä¸­çš„æ•°æ®å†™å…¥åˆ°æ–‡ä»¶ä¸­</li>
<li>manageFp &#x3D; false: è¯´æ˜æ–‡ä»¶æŒ‡é’ˆä¸æ˜¯<code>fmtlog</code>ç®¡ç†ï¼Œéœ€è°ƒç”¨<code>fflush</code>ç«‹å³åˆ·æ–°</li>
<li>è®¾ç½®ä¸‹æ¬¡åˆ·æ–°æ—¶é—´ä¸ºæœ€å¤§å€¼ï¼Œè¡¨ç¤ºâ€œä¸å†è®¡åˆ’ä¸»åŠ¨åˆ·æ–°â€ï¼Œéœ€è¦å¤–éƒ¨ä»£ç é‡æ–°è°ƒåº¦</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nextFlushTime = (std::numeric_limits&lt;<span class="type">int64_t</span>&gt;::max)();</span><br></pre></td></tr></table></figure>

<hr>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">startPollingThread</span><span class="params">(<span class="type">int64_t</span> pollInterval)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">stopPollingThread</span>();</span><br><span class="line">    threadRunning = <span class="literal">true</span>;</span><br><span class="line">    thr = std::<span class="built_in">thread</span>([pollInterval, <span class="keyword">this</span>]() &#123;</span><br><span class="line">        <span class="keyword">while</span> (threadRunning) &#123;</span><br><span class="line">            <span class="type">int64_t</span> before = fmtlogWrapper&lt;&gt;::impl.tscns.<span class="built_in">rdns</span>();</span><br><span class="line">            <span class="built_in">poll</span>(<span class="literal">false</span>);</span><br><span class="line">            <span class="type">int64_t</span> delay = fmtlogWrapper&lt;&gt;::impl.tscns.<span class="built_in">rdns</span>() - before;</span><br><span class="line">            <span class="keyword">if</span> (delay &lt; pollInterval) &#123;</span><br><span class="line">                std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">nanoseconds</span>(pollInterval - delay));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">poll</span>(<span class="literal">true</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">stopPollingThread</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!threadRunning) <span class="keyword">return</span>;</span><br><span class="line">    threadRunning = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (thr.<span class="built_in">joinable</span>()) thr.<span class="built_in">join</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>startPollingThread</code>å’Œ<code>stopPollingThread</code>å®ç°äº†è½®è¯¢çº¿ç¨‹çš„å¯åŠ¨å’Œåœæ­¢æœºåˆ¶ï¼Œç”¨äºå®šæœŸå¤„ç†æ—¥å¿—ä»»åŠ¡</p>
</blockquote>
<hr>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">handleLog</span><span class="params">(fmt::string_view threadName, <span class="type">const</span> fmtlog::SPSCVarQueueOPT::MsgHeader* header)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">setArgVal</span>&lt;<span class="number">6</span>&gt;(threadName);</span><br><span class="line">    StaticLogInfo&amp; info = bgLogInfos[header-&gt;logId];</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* data = (<span class="type">const</span> <span class="type">char</span>*)(header + <span class="number">1</span>);</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* end = (<span class="type">const</span> <span class="type">char</span>*)header + header-&gt;size;</span><br><span class="line">    <span class="type">int64_t</span> tsc = *(<span class="type">int64_t</span>*)data;</span><br><span class="line">    data += <span class="number">8</span>;</span><br><span class="line">    <span class="keyword">if</span> (!info.formatToFn) &#123; <span class="comment">// log once</span></span><br><span class="line">      info.location = *(<span class="type">const</span> <span class="type">char</span>**)data;</span><br><span class="line">      data += <span class="number">8</span>;</span><br><span class="line">      info.<span class="built_in">processLocation</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int64_t</span> ts = fmtlogWrapper&lt;&gt;::impl.tscns.<span class="built_in">tsc2ns</span>(tsc);</span><br><span class="line">    <span class="comment">// the date could go back when polling different threads</span></span><br><span class="line">    <span class="type">uint64_t</span> t = (ts &gt; midnightNs) ? (ts - midnightNs) : <span class="number">0</span>;</span><br><span class="line">    nanosecond.<span class="built_in">fromi</span>(t % <span class="number">1000000000</span>);</span><br><span class="line">    t /= <span class="number">1000000000</span>;</span><br><span class="line">    second.<span class="built_in">fromi</span>(t % <span class="number">60</span>);</span><br><span class="line">    t /= <span class="number">60</span>;</span><br><span class="line">    minute.<span class="built_in">fromi</span>(t % <span class="number">60</span>);</span><br><span class="line">    t /= <span class="number">60</span>;</span><br><span class="line">    <span class="type">uint32_t</span> h = t; <span class="comment">// hour</span></span><br><span class="line">    <span class="keyword">if</span> (h &gt; <span class="number">23</span>) &#123;</span><br><span class="line">      h %= <span class="number">24</span>;</span><br><span class="line">      <span class="built_in">resetDate</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    hour.<span class="built_in">fromi</span>(h);</span><br><span class="line">    <span class="built_in">setArgVal</span>&lt;<span class="number">14</span>&gt;(info.<span class="built_in">getBase</span>());</span><br><span class="line">    <span class="built_in">setArgVal</span>&lt;<span class="number">15</span>&gt;(info.<span class="built_in">getLocation</span>());</span><br><span class="line">    logLevel = (<span class="type">const</span> <span class="type">char</span>*)<span class="string">&quot;DBG INF WRN ERR OFF&quot;</span> + (info.logLevel &lt;&lt; <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> headerPos = membuf.<span class="built_in">size</span>();</span><br><span class="line">    fmtlog::<span class="built_in">vformat_to</span>(membuf, headerPattern, fmt::<span class="built_in">basic_format_args</span>(args.<span class="built_in">data</span>(), parttenArgSize));</span><br><span class="line">    <span class="type">size_t</span> bodyPos = membuf.<span class="built_in">size</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (info.formatToFn) &#123;</span><br><span class="line">      info.formatToFn(info.formatString, data, membuf, info.argIdx, args);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123; <span class="comment">// log once</span></span><br><span class="line">      membuf.<span class="built_in">append</span>(fmt::<span class="built_in">string_view</span>(data, end - data));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (logCB &amp;&amp; info.logLevel &gt;= minCBLogLevel) &#123;</span><br><span class="line">      <span class="built_in">logCB</span>(ts, info.logLevel, info.<span class="built_in">getLocation</span>(), info.basePos, threadName,</span><br><span class="line">            fmt::<span class="built_in">string_view</span>(membuf.<span class="built_in">data</span>() + headerPos, membuf.<span class="built_in">size</span>() - headerPos), bodyPos - headerPos,</span><br><span class="line">            fpos + headerPos);</span><br><span class="line">    &#125;</span><br><span class="line">    membuf.<span class="built_in">push_back</span>(<span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> (membuf.<span class="built_in">size</span>() &gt;= flushBufSize || info.logLevel &gt;= flushLogLevel) &#123;</span><br><span class="line">      <span class="built_in">flushLogFile</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>ç”¨<code>fmtlog</code>è‡ªå®šä¹‰æ ¼å¼åŒ–æ¨¡æ¿<code>headerPattern</code>å¡«å…¥å‚æ•°æ•°ç»„<code>args</code>ç”Ÿæˆæ—¥å¿—å‰ç¼€éƒ¨åˆ†</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">size_t</span> headerPos = membuf.<span class="built_in">size</span>();</span><br><span class="line">fmtlog::<span class="built_in">vformat_to</span>(membuf, headerPattern, fmt::<span class="built_in">basic_format_args</span>(args.<span class="built_in">data</span>(), parttenArgSize));</span><br><span class="line"><span class="type">size_t</span> bodyPos = membuf.<span class="built_in">size</span>();</span><br></pre></td></tr></table></figure>
<ul>
<li>é’ˆå¯¹æ ¼å¼åŒ–å‡½æ•°<code>formatToFn</code>æ˜¯å¦ä¸ºç©º<ul>
<li>éç©ºï¼šå°†æ—¥å¿—æ­£æ–‡æ ¼å¼åŒ–åæ‹¼æ¥åˆ°<code>membuf</code></li>
<li>ç©ºï¼šç›´æ¥æ‹·è´æ•°æ®æ®µä¸­çš„å­—ç¬¦ä¸²ï¼ˆå³logOnceï¼‰</li>
</ul>
</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (info.formatToFn) &#123;</span><br><span class="line">  info.formatToFn(info.formatString, data, membuf, info.argIdx, args);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  membuf.<span class="built_in">append</span>(fmt::<span class="built_in">string_view</span>(data, end - data));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">adjustHeap</span><span class="params">(<span class="type">size_t</span> i)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">      <span class="type">size_t</span> min_i = i;</span><br><span class="line">      <span class="keyword">for</span> (<span class="type">size_t</span> ch = i * <span class="number">2</span> + <span class="number">1</span>, end = std::<span class="built_in">min</span>(ch + <span class="number">2</span>, bgThreadBuffers.<span class="built_in">size</span>()); ch &lt; end; ch++) &#123;</span><br><span class="line">        <span class="keyword">auto</span> h_ch = bgThreadBuffers[ch].header;</span><br><span class="line">        <span class="keyword">auto</span> h_min = bgThreadBuffers[min_i].header;</span><br><span class="line">        <span class="keyword">if</span> (h_ch &amp;&amp; (!h_min || *(<span class="type">int64_t</span>*)(h_ch + <span class="number">1</span>) &lt; *(<span class="type">int64_t</span>*)(h_min + <span class="number">1</span>))) min_i = ch;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (min_i == i) <span class="keyword">break</span>;</span><br><span class="line">      std::<span class="built_in">swap</span>(bgThreadBuffers[i], bgThreadBuffers[min_i]);</span><br><span class="line">      i = min_i;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>adjustHeap</code>æ ¹æ®æ¯ä¸ª<code>bgThreadBuffers[i]</code>çš„<code>header</code>æ‰€è¡¨ç¤ºçš„æ—¶é—´æˆ³ï¼Œç»´æŒä¸€ä¸ªæœ€å°å †ç»“æ„ã€‚ç”¨äºåç»­å¿«é€Ÿæ‰¾åˆ°ä¸åŒçº¿ç¨‹ä¸­æœ€æ—©çš„æ—¥å¿—æ¶ˆæ¯</p>
</blockquote>
<hr>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">poll</span><span class="params">(<span class="type">bool</span> forceFlush)</span> </span>&#123;</span><br><span class="line">    fmtlogWrapper&lt;&gt;::impl.tscns.<span class="built_in">calibrate</span>();</span><br><span class="line">    <span class="type">int64_t</span> tsc = fmtlogWrapper&lt;&gt;::impl.tscns.<span class="built_in">rdtsc</span>();</span><br><span class="line">    <span class="keyword">if</span> (logInfos.<span class="built_in">size</span>()) &#123;</span><br><span class="line">      <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(logInfoMutex)</span></span>;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; info : logInfos) &#123;</span><br><span class="line">        info.<span class="built_in">processLocation</span>();</span><br><span class="line">      &#125;</span><br><span class="line">      bgLogInfos.<span class="built_in">insert</span>(bgLogInfos.<span class="built_in">end</span>(), logInfos.<span class="built_in">begin</span>(), logInfos.<span class="built_in">end</span>());</span><br><span class="line">      logInfos.<span class="built_in">clear</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (threadBuffers.<span class="built_in">size</span>()) &#123;</span><br><span class="line">      <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(bufferMutex)</span></span>;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">auto</span> tb : threadBuffers) &#123;</span><br><span class="line">        bgThreadBuffers.<span class="built_in">emplace_back</span>(tb);</span><br><span class="line">      &#125;</span><br><span class="line">      threadBuffers.<span class="built_in">clear</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; bgThreadBuffers.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">      <span class="keyword">auto</span>&amp; node = bgThreadBuffers[i];</span><br><span class="line">      <span class="keyword">if</span> (node.header) <span class="keyword">continue</span>;</span><br><span class="line">      node.header = node.tb-&gt;varq.<span class="built_in">front</span>();</span><br><span class="line">      <span class="keyword">if</span> (!node.header &amp;&amp; node.tb-&gt;shouldDeallocate) &#123;</span><br><span class="line">        <span class="keyword">delete</span> node.tb;</span><br><span class="line">        node = bgThreadBuffers.<span class="built_in">back</span>();</span><br><span class="line">        bgThreadBuffers.<span class="built_in">pop_back</span>();</span><br><span class="line">        i--;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (bgThreadBuffers.<span class="built_in">empty</span>()) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// build heap</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = bgThreadBuffers.<span class="built_in">size</span>() / <span class="number">2</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">      <span class="built_in">adjustHeap</span>(i);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">      <span class="keyword">auto</span> h = bgThreadBuffers[<span class="number">0</span>].header;</span><br><span class="line">      <span class="keyword">if</span> (!h || h-&gt;logId &gt;= bgLogInfos.<span class="built_in">size</span>() || *(<span class="type">int64_t</span>*)(h + <span class="number">1</span>) &gt;= tsc) <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">auto</span> tb = bgThreadBuffers[<span class="number">0</span>].tb;</span><br><span class="line">      <span class="built_in">handleLog</span>(fmt::<span class="built_in">string_view</span>(tb-&gt;name, tb-&gt;nameSize), h);</span><br><span class="line">      tb-&gt;varq.<span class="built_in">pop</span>();</span><br><span class="line">      bgThreadBuffers[<span class="number">0</span>].header = tb-&gt;varq.<span class="built_in">front</span>();</span><br><span class="line">      <span class="built_in">adjustHeap</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (membuf.<span class="built_in">size</span>() == <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">if</span> (!manageFp || forceFlush) &#123;</span><br><span class="line">      <span class="built_in">flushLogFile</span>();</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int64_t</span> now = fmtlogWrapper&lt;&gt;::impl.tscns.<span class="built_in">tsc2ns</span>(tsc);</span><br><span class="line">    <span class="keyword">if</span> (now &gt; nextFlushTime) &#123;</span><br><span class="line">      <span class="built_in">flushLogFile</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (nextFlushTime == (std::numeric_limits&lt;<span class="type">int64_t</span>&gt;::max)()) &#123;</span><br><span class="line">      nextFlushTime = now + flushDelay;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>åˆå§‹åŒ–æ¯ä¸ªçº¿ç¨‹çš„<code>header</code>ï¼ˆå½“å‰è¦å¤„ç†çš„æ—¥å¿—ï¼‰<ul>
<li>å¦‚æœå½“å‰æ²¡æœ‰å¾…å¤„ç†çš„æ—¥å¿—ï¼Œå°±ä»<code>varq</code>å–ä¸€ä¸ªï¼ˆ<code>SPSC</code>é˜Ÿåˆ—çš„<code>front</code>ï¼‰</li>
<li>å¦‚æœ<code>buffer</code>è¢«æ ‡è®°ä¸º<code>shouldDeallocate</code>ä¸”ä¹Ÿæ²¡æ—¥å¿—ï¼Œå¿«é€Ÿåˆ é™¤å¯¹åº”<code>buffer</code></li>
</ul>
</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; bgThreadBuffers.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">  <span class="keyword">auto</span>&amp; node = bgThreadBuffers[i];</span><br><span class="line">  <span class="keyword">if</span> (node.header) <span class="keyword">continue</span>;</span><br><span class="line">  node.header = node.tb-&gt;varq.<span class="built_in">front</span>();</span><br><span class="line">  <span class="keyword">if</span> (!node.header &amp;&amp; node.tb-&gt;shouldDeallocate) &#123;</span><br><span class="line">    <span class="keyword">delete</span> node.tb;</span><br><span class="line">    node = bgThreadBuffers.<span class="built_in">back</span>();</span><br><span class="line">    bgThreadBuffers.<span class="built_in">pop_back</span>();</span><br><span class="line">    i--;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>å»ºå †<ul>
<li>å¯¹æ‰€æœ‰çº¿ç¨‹ç¼“å†²åŒºæ„å»ºä¸€ä¸ªå°è·Ÿå †</li>
<li>ä»¥æ¯ä¸ªçº¿ç¨‹å½“å‰çš„æ—¥å¿—é¡¹<code>header</code>ä¸­çš„æ—¶é—´æˆ³ä¸ºä¼˜å…ˆçº§ï¼Œæœ€æ—©çš„æ—¥å¿—è°ƒæ•´åˆ°å †é¡¶</li>
</ul>
</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = bgThreadBuffers.<span class="built_in">size</span>() / <span class="number">2</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">  <span class="built_in">adjustHeap</span>(i);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://clee01.github.io/2025/04/11/movies/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Claark Lee">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hello, my world!">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Hello, my world!">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/04/11/movies/" class="post-title-link" itemprop="url">movies</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-04-11 19:14:50" itemprop="dateCreated datePublished" datetime="2025-04-11T19:14:50+08:00">2025-04-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-04-26 21:49:06" itemprop="dateModified" datetime="2025-04-26T21:49:06+08:00">2025-04-26</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          Here's something encrypted, password is required to continue reading.
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2025/04/11/movies/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://clee01.github.io/2025/03/31/Boost-asio/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Claark Lee">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hello, my world!">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Hello, my world!">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/03/31/Boost-asio/" class="post-title-link" itemprop="url">Boost::asio</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-03-31 14:53:15" itemprop="dateCreated datePublished" datetime="2025-03-31T14:53:15+08:00">2025-03-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-04-18 21:20:09" itemprop="dateModified" datetime="2025-04-18T21:20:09+08:00">2025-04-18</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="çŸ¥è¯†ç‚¹æç‚¼"><a href="#çŸ¥è¯†ç‚¹æç‚¼" class="headerlink" title="çŸ¥è¯†ç‚¹æç‚¼"></a>çŸ¥è¯†ç‚¹æç‚¼</h2><ul>
<li>Boost.Asioä½¿ç”¨<em>io_context</em>åŒæ“ä½œç³»ç»Ÿçš„è¾“å…¥&#x2F;è¾“å‡ºæœåŠ¡è¿›è¡Œäº¤äº’</li>
<li>io_contextæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå¯ä»¥è¢«å¤šä¸ªçº¿ç¨‹åŒæ—¶è°ƒç”¨</li>
<li>io_context::run()ä¼šé˜»å¡çº¿ç¨‹ï¼Œç›´åˆ°io_contextå†…éƒ¨çš„ä»»åŠ¡éƒ½å®Œæˆ</li>
<li>å•çº¿ç¨‹è°ƒç”¨io_context::run(): æ‰€æœ‰å›è°ƒéƒ½åœ¨è¯¥çº¿ç¨‹æ‰§è¡Œ</li>
<li>å¤šçº¿ç¨‹è°ƒç”¨io_context::run(): å¯¹ä¸ªçº¿ç¨‹å…±äº«io_contextçš„ä»»åŠ¡ï¼Œå¹¶å‘æ‰§è¡Œå›è°ƒ</li>
<li>socketç±»ä¸æ˜¯<em>çº¿ç¨‹å®‰å…¨</em>çš„</li>
<li>close(): å…³é—­å¥—æ¥å­—åï¼Œè°ƒç”¨è¿™ä¸ªå¥—æ¥å­—ä¸Šä»»ä½•çš„å¼‚æ­¥æ“ä½œéƒ½ä¼šè¢«ç«‹å³å…³é—­ï¼ŒåŒæ—¶è¿”å›<em>error::operation_aborted</em>é”™è¯¯ç </li>
<li>shutdown(type_of_shutdown): éƒ¨åˆ†å…³é—­å¥—æ¥å­—ï¼Œæ˜¯sendæˆ–receiveæ“ä½œå¤±æ•ˆï¼Œæˆ–ä¸¤è€…éƒ½å¤±æ•ˆã€‚åªæ˜¯é€»è¾‘ä¸Šçš„å…³é—­ï¼Œåº•å±‚çš„TCPè¿æ¥ä»ç„¶ä¿æŒ</li>
<li>cancel(): å–æ¶ˆå¥—æ¥å­—ä¸Šæ‰€æœ‰çš„å¼‚æ­¥æ“ä½œã€‚è¿™ä¸ªå¥—æ¥å­—ä¸Šä»»ä½•çš„å¼‚æ­¥æ“ä½œéƒ½ä¼šç«‹å³ç»“æŸï¼Œç„¶åè¿”å›error::operation_abortedé”™è¯¯ç ã€‚ä¸ä¼šå…³é—­å¥—æ¥å­—ï¼Œå¯ä»¥ç»§ç»­ä½¿ç”¨</li>
<li>å¥—æ¥å­—å®ä¾‹ä¸èƒ½è¢«æ‹·è´ï¼Œå…¶æ‹·è´æ„é€ å‡½æ•°å’Œèµ‹å€¼è¿ç®—ç¬¦è¢«åˆ é™¤æˆ–è®¾ä¸ºç§æœ‰</li>
<li>æµå¯ä»¥éšæœºè®¿é—®ï¼Œä½†æ˜¯å¥—æ¥å­—æ˜¯ä¸å¯å›æº¯çš„</li>
</ul>
<blockquote>
<p>ç›‘å¬å¾ªç¯</p>
</blockquote>
<table>
<thead>
<tr>
<th>æ–¹æ³•</th>
<th>é˜»å¡</th>
<th>å¤„ç†æ‰€æœ‰ä»»åŠ¡</th>
<th>é€‚ç”¨åœºæ™¯</th>
</tr>
</thead>
<tbody><tr>
<td>run()</td>
<td>æ˜¯</td>
<td>æ˜¯</td>
<td>é€‚ç”¨äºé•¿æœŸè¿è¡Œçš„ç¨‹åºï¼Œå¦‚æœåŠ¡å™¨</td>
</tr>
<tr>
<td>poll()</td>
<td>å¦</td>
<td>å¦ï¼ˆä»…æ‰§è¡Œå½“å‰å¯ç”¨ä»»åŠ¡ï¼‰</td>
<td>é€‚ç”¨äºäº‹ä»¶è½®è¯¢ï¼Œé¿å…é˜»å¡çº¿ç¨‹</td>
</tr>
</tbody></table>
<blockquote>
<p>å¼‚æ­¥è°ƒç”¨æ–¹æ³•</p>
</blockquote>
<table>
<thead>
<tr>
<th>æ–¹æ³•</th>
<th>ä»»åŠ¡æ‰§è¡Œæ–¹å¼</th>
<th>æ˜¯å¦ç«‹å³æ‰§è¡Œ</th>
<th>çº¿ç¨‹å®‰å…¨æ€§</th>
<th>é€‚ç”¨åœºæ™¯</th>
</tr>
</thead>
<tbody><tr>
<td>post()</td>
<td>æ€»æ˜¯å¼‚æ­¥æ‰§è¡Œ</td>
<td>å¦</td>
<td>æ˜¯</td>
<td>å§‹ç»ˆå¼‚æ­¥æäº¤ä»»åŠ¡ï¼Œä¸ç®¡å“ªä¸ªçº¿ç¨‹è°ƒç”¨ï¼Œéƒ½åŠ å…¥io_contexté˜Ÿåˆ—</td>
</tr>
<tr>
<td>dispatch()</td>
<td>å½“å‰çº¿ç¨‹æ˜¯io_contextçº¿ç¨‹ï¼šåŒæ­¥æ‰§è¡Œ å¦åˆ™ï¼šå¼‚æ­¥æäº¤åˆ°io_context</td>
<td>å¯èƒ½ç«‹å³æ‰§è¡Œ</td>
<td>æ˜¯</td>
<td>ä¼˜å…ˆåœ¨å½“å‰çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œå¦‚æœä¸åœ¨io_contextçº¿ç¨‹ï¼Œåˆ™å˜ä¸ºå¼‚æ­¥æäº¤</td>
</tr>
<tr>
<td>wrap()</td>
<td>åˆ›å»ºåŒ…è£…å™¨ï¼Œä¸€èˆ¬ç”¨äºä¿è¯strandä»»åŠ¡æŒ‰é¡ºåºæ‰§è¡Œ</td>
<td>å–å†³äºpost()æˆ–dispatch()</td>
<td>æ˜¯</td>
<td>ä¿è¯ä»»åŠ¡é¡ºåºæ‰§è¡Œï¼Œå³ä½¿ä»»åŠ¡åœ¨ä¸åŒçº¿ç¨‹ä¸Šè¿è¡Œ</td>
</tr>
</tbody></table>
<ul>
<li>ä¸ºäº†ä½¿socketå’Œç¼“å†²åŒºï¼ˆreadæˆ–è€…writeï¼‰åœ¨æ•´ä¸ªå¼‚æ­¥æ“ä½œçš„ç”Ÿå‘½å‘¨æœŸä¸­ä¸€ç›´æ´»åŠ¨ï¼Œéœ€è¦é‡‡å–ç‰¹æ®Šçš„é˜²æŠ¤æªæ–½ï¼šè¿æ¥ç±»éœ€è¦ç»§æ‰¿è‡ªenable_shared_from_thisï¼Œç„¶ååœ¨å†…éƒ¨ä¿å­˜å®ƒéœ€è¦çš„ç¼“å†²åŒºï¼Œè€Œä¸”æ¯æ¬¡å¼‚æ­¥è°ƒç”¨éƒ½è¦ä¼ é€’ä¸€ä¸ªæ™ºèƒ½æŒ‡é’ˆç»™thisæ“ä½œ<blockquote>
<p>åç¨‹æ”¯æŒ</p>
</blockquote>
</li>
</ul>
<table>
<thead>
<tr>
<th>æ–¹å¼</th>
<th>é€‚ç”¨æƒ…å†µ</th>
<th>ä¼˜åŠ¿</th>
<th>åŠ£åŠ¿</th>
</tr>
</thead>
<tbody><tr>
<td>co_await (C++20)</td>
<td>ç°ä»£C++é¡¹ç›®</td>
<td>è¯­æ³•ç®€æ´ï¼Œç¼–è¯‘å™¨ä¼˜åŒ–å¥½</td>
<td>éœ€è¦C++20</td>
</tr>
<tr>
<td>spawn() (C++11)</td>
<td>C++11&#x2F;14</td>
<td>è¯­æ³•ç®€å•ï¼ŒåƒåŒæ­¥ä»£ç </td>
<td>éœ€è¦boost::asio::yield_context</td>
</tr>
<tr>
<td>coroutine (C++11)</td>
<td>ç»†ç²’åº¦æ§åˆ¶åç¨‹</td>
<td>æ— éœ€é¢å¤–ä¾èµ–</td>
<td>ä»£ç å¤æ‚</td>
</tr>
</tbody></table>
<h2 id="è¸©è¿‡çš„å‘"><a href="#è¸©è¿‡çš„å‘" class="headerlink" title="è¸©è¿‡çš„å‘"></a>è¸©è¿‡çš„å‘</h2><p><mark>1. async_writeæœ¬èº«æ˜¯ä¸ªç»„åˆæ“ä½œï¼Œå†…éƒ¨å®é™…ä¸Šæ˜¯è°ƒç”¨å¤šæ¬¡æ›´åº•å±‚çš„async_write_some()æ¥æŠŠæ•´ä¸ªbufferå†™å®Œã€‚æ‰€ä»¥å³ä½¿ä½¿ç”¨strandä¿è¯äº†æ‰€æœ‰handleræ˜¯ä¸²è¡Œæ‰§è¡Œçš„ï¼Œä½†æ˜¯å¤šä¸ªasync_writeåŒæ—¶å‘èµ·æ—¶ï¼Œå®ƒä»¬çš„å¤šä¸ªå†…éƒ¨async_write_someå¯èƒ½ä¼šäº¤é”™è¿›è¡Œï¼ˆå› ä¸ºåŒæ—¶è°ƒäº†å¤šä¸ªasync_writeï¼‰<mark> <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/7754695/boost-asio-async-write-how-to-not-interleaving-async-write-calls">æœ€ä½³å®è·µ</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://clee01.github.io/2025/03/13/AI%E7%9F%A5%E8%AF%86%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Claark Lee">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hello, my world!">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Hello, my world!">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/03/13/AI%E7%9F%A5%E8%AF%86%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">AIçŸ¥è¯†ç¬”è®°</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-03-13 00:00:10" itemprop="dateCreated datePublished" datetime="2025-03-13T00:00:10+08:00">2025-03-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-04-11 14:24:54" itemprop="dateModified" datetime="2025-04-11T14:24:54+08:00">2025-04-11</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="çŸ¥è¯†ç‚¹æç‚¼"><a href="#çŸ¥è¯†ç‚¹æç‚¼" class="headerlink" title="çŸ¥è¯†ç‚¹æç‚¼"></a>çŸ¥è¯†ç‚¹æç‚¼</h2><ul>
<li>Prompt Engineering: å’ŒLLMè¿›è¡Œåä½œ<ul>
<li>Zero-shot Prompting(é›¶æ ·æœ¬æç¤º)</li>
<li>Few-shot Learning&#x2F;Prompting(å°‘æ ·æœ¬å­¦ä¹ &#x2F;æç¤º)</li>
</ul>
</li>
<li>Function Calling: åº”ç”¨æä¾›ä¸€ç³»åˆ—çš„Toolsä¾›LLMæŠ‰æ‹©ä½¿ç”¨</li>
<li>RAG(Retrieval-Augmented Generation): æ£€ç´¢å¢å¼ºç”Ÿæˆï¼Œé’ˆå¯¹ä¸Šä¸‹æ–‡é•¿åº¦æœ‰é™åˆ¶çš„ä¸»æµè§£å†³æ–¹æ¡ˆ</li>
<li>Chunk(æ–‡æœ¬åˆ†å—): å°½é‡ä¿è¯ä¸Šä¸‹æ–‡è¯­ä¹‰çš„è¿è´¯æ€§çš„åŒæ—¶ï¼Œåˆèƒ½å¤Ÿè®©åˆ‡åˆ†çš„å—å°½é‡çš„å°</li>
<li>Embedding(å‘é‡åŒ–): é€šè¿‡æ¨¡å‹å°†å„ç§å†…å®¹(è¯ã€å¥å­ã€å›¾ç‰‡ç­‰)è½¬åŒ–æˆé«˜ç»´å‘é‡çš„è¿‡ç¨‹</li>
<li>VectorDB(å‘é‡æ•°æ®åº“)</li>
<li>åŸºåº§å¤§æ¨¡å‹</li>
<li>LLMåº”ç”¨å®é™…è§£å†³é—®é¢˜çš„è´¨é‡<ul>
<li>RAGå¬å›æ•°æ®çš„è´¨é‡(ç›¸å…³æ€§)</li>
<li>å¤§æ¨¡å‹æœ¬èº«çš„æ¨ç†ç†è§£èƒ½åŠ›</li>
</ul>
</li>
<li>AI Agent: åˆ©ç”¨å¤–éƒ¨Toolså¤„ç†å„é¡¹ä»»åŠ¡</li>
<li>MCP(Model Context Protocol): ä¸²è”AI Agentç”Ÿæ€çš„åè®®</li>
</ul>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ol>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/kcGfK7ANUB2tbERjXAvbLw">ä¸éœ€è¦AIå’Œæ•°å­¦çŸ¥è¯†èƒŒæ™¯ï¼Œè¿™ç¯‡æ–‡ç« å¸¦ä½ å­¦ä¼šå¤§æ¨¡å‹åº”ç”¨å¼€å‘</a></li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://clee01.github.io/2025/03/07/Cpp%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Claark Lee">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hello, my world!">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Hello, my world!">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/03/07/Cpp%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/" class="post-title-link" itemprop="url">C++å¼‚å¸¸å¤„ç†ç¬”è®°</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-03-07 13:58:48" itemprop="dateCreated datePublished" datetime="2025-03-07T13:58:48+08:00">2025-03-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-04-11 14:26:23" itemprop="dateModified" datetime="2025-04-11T14:26:23+08:00">2025-04-11</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="çŸ¥è¯†ç‚¹æç‚¼"><a href="#çŸ¥è¯†ç‚¹æç‚¼" class="headerlink" title="çŸ¥è¯†ç‚¹æç‚¼"></a>çŸ¥è¯†ç‚¹æç‚¼</h2><ul>
<li>å¼‚å¸¸äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œå¦‚æœä¸€ç›´å›é€€åˆ°ä¸»å‡½æ•°mainéƒ½ä¸èƒ½å¤„ç†è¯¥å¼‚å¸¸ï¼Œåˆ™è°ƒç”¨ç³»ç»Ÿå‡½æ•°terminateç»ˆæ­¢ç¨‹åº</li>
<li>æ‰§è¡Œthrowè¯­å¥æ—¶ï¼Œå…¶æ“ä½œæ•°çš„ç»“æœä½œä¸ºå¯¹è±¡è¢«å¤åˆ¶æ„é€ ä¸ºä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼Œæ”¾åœ¨å†…å­˜çš„ç‰¹æ®Šä½ç½®ï¼šä¸æ˜¯å †æ ˆä¸Š<ul>
<li>Windowsä¸Šæ˜¯æ”¾åœ¨çº¿ç¨‹ä¿¡æ¯å—TIBä¸­</li>
<li>Linuxä¸Šæ˜¯æ”¾åœ¨TCB(Thread Control Block)&#x2F;TLS(Thread Local Storage)ä¸­<blockquote>
<p>åœ¨libstdc++ï¼ˆGCCçš„æ ‡å‡†åº“å®ç°ï¼‰ä¸­ï¼Œå¼‚å¸¸å¯¹è±¡çš„å­˜å‚¨å’Œç®¡ç†æ¶‰åŠ__cxa_allocate_exception()å’Œ__cxa_get_globals()ç­‰å‡½æ•°ã€‚__cxa_allocate_exception()åœ¨å †ä¸Šåˆ†é…å¼‚å¸¸å¯¹è±¡ï¼›GCCé€šè¿‡__cxa_get_globals()è·å–å½“å‰çº¿ç¨‹çš„å¼‚å¸¸å¤„ç†æ•°æ®ç»“æ„__cxa_eh_globalsï¼Œå®ƒé€šå¸¸å­˜å‚¨åœ¨TLSæˆ–TCBä¸­ï¼›__cxa_eh_globalsç»“æ„ä½“å­˜å‚¨äº†å½“å‰çº¿ç¨‹çš„å¼‚å¸¸å¯¹è±¡æŒ‡é’ˆï¼Œä½†å¹¶ä¸æ˜¯å­˜å‚¨å¼‚å¸¸å¯¹è±¡æœ¬èº«</p>
</blockquote>
</li>
</ul>
</li>
<li>throwè¯­å¥æŠ›å‡ºçš„å¼‚å¸¸å¯¹è±¡åœ¨åŒ¹é…æˆåŠŸçš„catchè¯­å¥çš„ç»“æŸå¤„è¢«ææ„ï¼ˆå³ä½¿è¯¥catchè¯­å¥ä½¿ç”¨çš„æ˜¯éå¼•ç”¨çš„ä¼ å€¼å‚æ•°ç±»å‹ï¼‰</li>
<li>ç”±äºthrowè¯­å¥éƒ½è¿›è¡Œäº†ä¸€æ¬¡å‰¯æœ¬æ‹·è´ï¼Œå› æ­¤å¼‚å¸¸å¯¹è±¡åº”è¯¥æ˜¯å¯ä»¥å¤åˆ¶æ„é€ çš„<ul>
<li>C++98&#x2F;03ï¼šå¼‚å¸¸å¯¹è±¡å¿…é¡»æ”¯æŒæ‹·è´æ„é€ </li>
<li>C++11åŠä»¥åï¼šå¯ä»¥æ”¯æŒç§»åŠ¨æ„é€ ï¼Œå‡å°‘æ€§èƒ½æŸè€—</li>
</ul>
</li>
<li>æŠ›å‡ºä¸€ä¸ªè¡¨è¾¾å¼æ—¶ï¼Œè¢«æŠ›å‡ºå¯¹è±¡çš„é™æ€ç¼–è¯‘æ—¶ç±»å‹å°†å†³å®šå¼‚å¸¸å¯¹è±¡çš„ç±»å‹</li>
<li>å¼‚å¸¸è§„æ ¼åœ¨C++11ä¸­è¢«å¼ƒç”¨ï¼ŒC++11å®šä¹‰äº†æ–°çš„noexceptå…³é”®å­—ï¼Œå¦‚æœåœ¨å‡½æ•°å£°æ˜åç›´æ¥åŠ ä¸Šnoexceptå…³é”®å­—ï¼Œè¡¨ç¤ºå‡½æ•°ä¸ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚å¦‚æœä¿è¯ä¸æŠ›å‡ºå¼‚å¸¸çš„å‡½æ•°å®é™…ä¸ŠæŠ›å‡ºäº†å¼‚å¸¸ï¼Œå°†ç›´æ¥è°ƒç”¨terminateç»ˆæ­¢ç¨‹åºçš„è¿è¡Œ</li>
</ul>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ol>
<li><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/C%2B%2B%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86">C++å¼‚å¸¸å¤„ç†</a></li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://clee01.github.io/2025/03/06/%E4%B8%AA%E4%BA%BA2025%E5%B9%B4%E8%A7%84%E5%88%92/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Claark Lee">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hello, my world!">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Hello, my world!">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/03/06/%E4%B8%AA%E4%BA%BA2025%E5%B9%B4%E8%A7%84%E5%88%92/" class="post-title-link" itemprop="url">ä¸ªäºº2025å¹´è§„åˆ’</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-03-06 18:01:48" itemprop="dateCreated datePublished" datetime="2025-03-06T18:01:48+08:00">2025-03-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-04-11 14:27:14" itemprop="dateModified" datetime="2025-04-11T14:27:14+08:00">2025-04-11</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <ul>
<li>3æœˆè§„åˆ’<ul>
<li>3fs</li>
<li>ceph</li>
<li>etcd</li>
<li>boost::asio</li>
<li>C++20:coroutine</li>
<li>zookeeper</li>
</ul>
</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Claark Lee</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

</body>
</html>
